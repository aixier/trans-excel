# 极简自动化工作流设计

## 设计理念

**零配置、全自动、可视化**

用户只需两步：
1. 上传文件
2. 选择术语库（可选）

系统自动完成所有其他工作。

---

## 用户交互流程

```
┌─────────────────────────────────────────────┐
│  步骤1: 上传文件                             │
│  用户拖拽 Excel 文件                         │
│  ↓ 自动执行: 上传 + 分析 (2秒)              │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  步骤2: 确认配置（唯一的用户交互）           │
│                                              │
│  显示内容:                                   │
│  • 文件名                                    │
│  • 检测语言: 中文 → 英文, 泰语, 葡萄牙语    │
│  • 任务预估: 1,400 条，约 2 分钟            │
│  • ⚠️ CAPS 警告（如果有）                   │
│                                              │
│  术语库选择（3选1）:                         │
│  ○ 不使用术语库                             │
│  ● 选择已有术语库                           │
│  ○ 上传新术语库                             │
│                                              │
│  [🚀 开始翻译]  [❌ 取消]                   │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  步骤3: 自动执行（全自动）                   │
│                                              │
│  标准流程（无CAPS）:                         │
│  1. 拆分任务     ████░░░░ 20%               │
│  2. AI翻译      ████████░ 80%               │
│  3. 完成下载    ██████████ 100%             │
│                                              │
│  CAPS流程:                                   │
│  阶段1/2: 标准翻译                           │
│  1. 拆分翻译任务   ████░░░░░░ 20%           │
│  2. AI翻译        ████████░░ 60%            │
│  阶段2/2: CAPS转换                           │
│  3. 拆分CAPS任务   █████████░ 70%           │
│  4. CAPS转换      ██████████ 95%            │
│  5. 完成下载      ██████████ 100%           │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│  步骤4: 完成页面                             │
│                                              │
│  🎉 翻译完成！                               │
│  文件: game_final.xlsx (2.3 MB)            │
│                                              │
│  📊 处理摘要:                               │
│  • 总任务: 1,400 条                         │
│  • 成功: 1,395 条 (99.6%)                  │
│  • 失败: 5 条                               │
│  • 总耗时: 1分58秒                          │
│                                              │
│  [📥 立即下载]  [🔄 处理新文件]             │
└─────────────────────────────────────────────┘
```

---

## 自动化参数

所有参数都由系统自动处理：

| 参数 | 自动化方式 |
|------|-----------|
| 源语言 | 从分析结果自动检测 |
| 目标语言 | 从分析结果自动检测 |
| 规则集 | 根据是否有CAPS自动选择 |
| 处理器 | 翻译用LLM，CAPS用uppercase |
| 并发数 | 使用默认值（10 for LLM, 20 for CAPS） |
| 上下文提取 | 默认开启 |

**用户只需决定**: 是否使用术语库

---

## 两种工作流

### 工作流A: 标准翻译（无CAPS）

```
上传文件
  ↓ (自动分析)
确认配置 + 选择术语库
  ↓ (自动拆分)
拆分任务 (translation规则集)
  ↓ (自动执行)
AI翻译 (llm_qwen处理器)
  ↓ (自动完成)
下载结果
```

**预计时间**: 约2分钟（1,200条任务）

### 工作流B: 翻译 + CAPS转换

```
上传文件
  ↓ (自动分析，检测到CAPS工作表)
确认配置 + 选择术语库 + CAPS警告
  ↓
━━━ 阶段1: 标准翻译 ━━━
  ↓ (自动拆分)
拆分翻译任务 (translation规则集，排除CAPS)
  ↓ (自动执行)
AI翻译 (llm_qwen处理器)
  ↓ (翻译完成)
━━━ 阶段2: CAPS转换 ━━━
  ↓ (自动从阶段1继承)
拆分CAPS任务 (caps_only规则集)
  ↓ (自动执行)
CAPS转换 (uppercase处理器)
  ↓ (自动完成)
下载最终结果
```

**预计时间**: 约2分钟（1,200翻译 + 150 CAPS）

---

## 术语库集成

### 三种选择方式

1. **不使用术语库**
   - 最快，但专有名词可能不一致
   - 适合：非游戏内容、测试文件

2. **选择已有术语库**
   - 下拉选择，显示术语条目数
   - 实时预估匹配数量
   - 适合：常规游戏翻译

3. **上传新术语库**
   - 一键上传.xlsx文件
   - 自动保存到系统，下次可选用
   - 适合：新项目、新游戏

### 术语库格式

```
Excel文件，必须包含以下列：
CH | EN | TH | PT | VN | ...

示例:
CH          EN          TH          PT
攻击力      ATK         พลังโจมตี   Ataque
魔法值      MP          มานา        Mana
```

---

## CAPS工作流详解

### 为什么需要两阶段处理？

CAPS转换**必须基于翻译后的内容**，不能基于原始中文：

```
❌ 错误流程:
原始: "攻击力" → CAPS转换 → "攻击力" (无意义)

✅ 正确流程:
原始: "攻击力" → 翻译 → "ATK" → CAPS转换 → "ATK"
```

### 自动检测逻辑

系统通过以下方式检测CAPS工作表：
- 工作表名称包含 "caps"（不区分大小写）
- 如: "CAPS", "Caps", "caps_sheet", "CAPS_EN"

### 自动处理流程

1. **检测到CAPS** → 显示警告 "⚠️ 包含 CAPS 工作表"
2. **阶段1** → 使用 `translation` 规则集（自动排除CAPS）
3. **阶段1完成** → 自动创建child session
4. **阶段2** → 使用 `caps_only` 规则集
5. **阶段2完成** → 下载最终文件

用户无需任何操作，系统自动完成所有阶段切换。

---

## 进度显示

### 标准流程进度映射

```
0-10%:   上传分析
10-20%:  拆分任务
20-90%:  AI翻译执行 (70% 时间)
90-100%: 生成下载文件
```

### CAPS流程进度映射

```
0-5%:    上传分析
5-10%:   拆分翻译任务
10-60%:  AI翻译执行 (50% 时间)
60-65%:  阶段切换
65-70%:  拆分CAPS任务
70-95%:  CAPS转换执行 (25% 时间)
95-100%: 生成下载文件
```

### 实时更新

通过 WebSocket 实时更新：
- 当前批次进度
- 成功/失败任务数
- 剩余时间预估
- 实时日志滚动

---

## 错误处理

### 上传阶段

- **文件格式错误**: 提示 "仅支持 .xlsx 文件"
- **文件过大**: 提示 "文件超过50MB限制"
- **分析失败**: 提示具体错误信息

### 执行阶段

- **部分失败**: 继续执行，最后显示失败任务
- **完全失败**: 停止执行，提示错误
- **网络断开**: 显示重连提示

### 失败任务处理

- 失败任务单独导出为Excel
- 包含失败原因
- 提供重试按钮
- 不影响成功任务的下载

---

## 技术实现

### 核心组件

1. **AutoWorkflowOrchestrator** - 工作流编排器
   - 自动选择工作流类型
   - 管理阶段切换
   - 处理session链

2. **ConfigConfirmModal** - 配置确认对话框
   - 显示分析结果
   - 术语库选择
   - 触发工作流

3. **ProgressMonitor** - 进度监控器
   - WebSocket连接
   - 实时进度更新
   - 日志显示

### API调用流程

```javascript
// 标准流程
uploadFile(file)
  → waitForAnalysis()
  → showConfigModal()
  → startExecution(session_id, processor='llm_qwen')
  → monitorProgress()
  → downloadResult()

// CAPS流程
uploadFile(file)
  → waitForAnalysis()
  → showConfigModal() [显示CAPS警告]
  → startExecution(session_id_1, processor='llm_qwen')
  → monitorProgress()
  → splitFromParent(session_id_1, rule_set='caps_only')
  → startExecution(session_id_2, processor='uppercase')
  → monitorProgress()
  → downloadResult(session_id_2)
```

---

## 文件结构

```
frontend_v2/
├── js/
│   ├── workflows/
│   │   ├── auto-workflow-orchestrator.js  # 工作流编排器
│   │   ├── config-confirm-modal.js        # 配置确认对话框
│   │   └── progress-monitor.js            # 进度监控
│   └── pages/
│       └── upload-page.js                 # 上传页面（集成工作流）
└── docs/
    └── AUTO_WORKFLOW.md                   # 本文档
```

---

## 用户体验优化

### 1. 智能预估
- 基于任务数量和历史数据预估时间
- 显示置信度："约2分钟"vs"1-3分钟"

### 2. 可视化反馈
- 上传进度条
- 分析动画
- 执行阶段指示器
- 实时日志滚动

### 3. 中断恢复
- 可随时暂停/取消
- 关闭页面后可继续
- 失败自动重试

### 4. 移动端友好
- 响应式设计
- 触摸优化
- 简洁布局

---

## 未来优化方向

1. **批量上传**: 支持多个文件同时处理
2. **历史记录**: 快速重用之前的配置
3. **模板保存**: 保存常用配置为模板
4. **邮件通知**: 长时间任务完成后发送邮件
5. **API接入**: 提供API供外部系统调用

---

## 总结

**设计原则**:
- ✅ 极简交互（只有2个决策点）
- ✅ 全自动执行（无需配置参数）
- ✅ 智能分流（自动识别CAPS）
- ✅ 可视化进度（实时反馈）
- ✅ 容错处理（失败不影响整体）

**用户价值**:
- 🚀 上手即用，无需培训
- ⏱️ 节省时间，减少操作
- 🎯 专注核心，选择术语库
- 📊 透明可控，进度可见
