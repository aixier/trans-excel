# LLM设置和Prompt配置文档

## 一、LLM基础设置

### 1. 模型配置
- **提供商**: dashscope (阿里云百炼)
- **模型**: qwen-plus (通义千问Plus)
- **API地址**: https://dashscope.aliyuncs.com/compatible-mode/v1
- **API密钥**: 从环境变量读取

### 2. API调用参数
```python
temperature: 0.3          # 较低温度，追求稳定输出
max_tokens: 4000         # 最大输出token数
response_format: {"type": "json_object"}  # 强制JSON格式输出
```

### 3. 翻译系统参数
```python
default_batch_size: 10        # 默认批次大小
default_max_concurrent: 20    # 最大并发数
default_max_iterations: 5     # 最大迭代轮数
max_batch_size: 30            # 最大批次大小限制
default_region_code: "auto"   # 自动根据语言选择区域
```

### 4. 超时和重试策略
- **初始超时**: 90秒
- **最大重试次数**: 2次（长文本3次）
- **重试延迟**: 3秒基础延迟，指数退避
- **动态超时调整**:
  - 每次重试增加50%超时时间
  - 长文本(>500字符): 180-360秒
  - 最大超时: 600秒(10分钟)

### 5. 批次大小动态调整
- **基础策略**: 根据文本长度动态调整
- **长文本处理**:
  - 500-1000字符: 批次大小减半，超时180秒
  - 1000-2000字符: 批次大小为3，超时240秒
  - >2000字符: 批次大小为1，超时360秒

## 二、Prompt模板结构

### 1. 系统提示词模板
```
你是专业的游戏本地化翻译专家，专门为{region.name}地区进行本地化翻译。

地区特点：
- 文化背景：{region.cultural_context}
- 本地化要点：{region.localization_notes}

翻译任务：
- 源语言：中文
- 目标语言：{target_languages}
- 目标地区：{region.name}
- 游戏背景：{game_background}  # 可选
```

### 2. 翻译要求（关键部分）
```
翻译要求：
1. 必须将所有中文内容完全翻译为目标语言，绝对不能保留任何中文字符
2. 保持原文的游戏语境和情感色彩
3. 使用符合目标地区文化特点的表达方式
4. 保护占位符完整性（如 %s, %d, {{num}}, <font> 等）
5. 输出结果中绝对不允许出现任何中文字符或汉字
6. 返回纯JSON格式，不要其他内容
```

### 3. 用户消息格式
```
请翻译以下中文文本：
[
  {
    "id": "batch_1_text_0",
    "text": "需要翻译的中文文本"
  },
  ...
]
```

### 4. 期望响应格式
```json
{
  "translations": [
    {
      "id": "batch_1_text_0",
      "original_text": "原文",
      "en": "英语翻译",
      "pt": "葡萄牙语翻译",
      "vn": "越南语翻译",
      ...
    }
  ]
}
```

## 三、区域配置

### 1. 支持的区域
- **na (北美)**: 英语，西方文化，直接沟通
- **sa (南美)**: 葡萄牙语、西班牙语，拉丁文化
- **me (中东)**: 阿拉伯语，传统价值观
- **as (东南亚)**: 泰语、印尼语、越南语，多元文化
- **eu (欧洲)**: 多语言，正式沟通

### 2. 语言-区域自动映射
```python
'vn' -> 'as'  # 越南语 -> 东南亚
'en' -> 'na'  # 英语 -> 北美
'pt' -> 'sa'  # 葡萄牙语 -> 南美
'th' -> 'as'  # 泰语 -> 东南亚
'ar' -> 'me'  # 阿拉伯语 -> 中东
```

## 四、关键优化点

### 1. 防止中文残留
- Prompt中多次强调"绝对不能保留任何中文字符"
- 要求"输出结果中绝对不允许出现任何中文字符或汉字"

### 2. 智能区域选择
- 根据目标语言自动选择合适的文化区域
- 避免区域与语言不匹配的问题

### 3. 占位符保护
- 识别并保护游戏中的占位符（%s, %d, {num}等）
- 翻译后自动还原占位符

### 4. 长文本优化
- 动态调整批次大小和超时时间
- 长文本单独处理，避免超时

## 五、常见问题处理

### 1. 翻译不完整
- **原因**: Prompt指导不明确
- **解决**: 强调必须完全翻译所有内容

### 2. 混合语言输出
- **原因**: 模型理解偏差
- **解决**: 明确禁止保留源语言字符

### 3. 超时问题
- **原因**: 文本过长或API响应慢
- **解决**: 动态超时调整，长文本特殊处理

### 4. 区域文化不匹配
- **原因**: 固定区域设置
- **解决**: 自动根据语言选择合适区域