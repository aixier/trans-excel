# 第一阶段开发任务清单

## 阶段目标
实现基础数据层和任务拆分功能，能够上传Excel、分析文件、生成任务DataFrame并导出观测

## 任务列表

| 序号 | 状态 | 任务名称 | 目标 | 参考文件 | 依赖 |
|------|------|---------|------|---------|------|
| 1.1 | ⬜ | 创建项目结构 | 搭建基础项目框架和目录结构 | - | - |
| 1.2 | ⬜ | 配置文件管理 | 实现config.yaml加载，包含max_chars_per_batch和max_concurrent_workers参数 | 系统设计方案_v3.md#2.1 | 1.1 |
| 1.3 | ⬜ | 定义任务DataFrame结构 | 创建包含30个字段的DataFrame模型类（含game_context） | 系统设计方案_v3.md#3.1 | 1.1 |
| 1.4 | ⬜ | 定义Excel DataFrame结构 | 创建Excel内存存储结构（含color_map、comment_map） | 系统设计方案_v3.md#3.3 | 1.1 |
| 1.5 | ⬜ | 实现Excel加载器 | 读取Excel文件到pandas DataFrame，提取颜色和注释 | - | 1.4 |
| 1.6 | ⬜ | 实现语言检测 | 自动识别CH/EN源语言列和PT/TH/VN目标语言列 | - | 1.5 |
| 1.7 | ⬜ | 实现游戏信息处理 | 处理上传时的game_info参数，存储游戏背景信息 | - | 1.3 |
| 1.8 | ⬜ | 实现Excel分析器 | 统计文件信息、字符分布、预估任务数 | - | 1.5, 1.6 |
| 1.9 | ⬜ | 创建分析API接口 | POST /api/analyze/upload 接收Excel和game_info返回分析报告 | 渐进式开发计划.md#1.2 | 1.7, 1.8 |
| 1.10 | ⬜ | 实现上下文提取器 | 从注释、相邻单元格和游戏信息提取source_context | 任务分组策略说明.md#3.2.4 | 1.5, 1.7 |
| 1.11 | ⬜ | 实现任务识别逻辑 | 判断空值/黄色/蓝色等任务类型 | - | 1.5, 1.10 |
| 1.12 | ⬜ | 实现group_id分配 | 按Sheet或内容类型分配业务分组ID | 任务分组策略说明.md#3.2.3 | 1.11 |
| 1.13 | ⬜ | 实现batch_id分配算法 | 基于max_chars_per_batch动态分配批次 | 任务分组策略说明.md#3.2.2 | 1.2, 1.11 |
| 1.14 | ⬜ | 创建任务拆分核心逻辑 | 生成完整的任务DataFrame（包含game_context） | 系统设计方案_v3.md#7.2.2 | 1.3, 1.11, 1.12, 1.13 |
| 1.15 | ⬜ | 创建拆分API接口 | POST /api/tasks/split 返回任务统计信息 | 渐进式开发计划.md#1.3 | 1.14 |
| 1.16 | ⬜ | 实现任务DataFrame导出 | 将任务DataFrame导出为Excel格式 | - | 1.14 |
| 1.17 | ⬜ | 创建导出API接口 | GET /api/tasks/export/{session_id} 下载任务Excel | 渐进式开发计划.md#1.3 | 1.16 |
| 1.18 | ⬜ | 实现内存会话管理 | 管理session_id与DataFrame及game_info的映射关系 | - | 1.9, 1.15 |
| 1.19 | ⬜ | 创建测试数据 | 准备small/medium/large/colored测试Excel和game_info示例 | - | - |
| 1.20 | ⬜ | 编写单元测试 | 测试核心功能模块（包含游戏信息处理） | - | All |
| 1.21 | ⬜ | 集成测试 | 端到端流程测试：上传Excel+game_info→分析→拆分→导出 | - | 1.20 |

## 项目结构

```
backend_v2/
├── config/
│   └── config.yaml              # 配置文件
├── models/
│   ├── task_dataframe.py        # 任务DataFrame定义（含game_context）
│   ├── excel_dataframe.py       # Excel DataFrame定义
│   └── game_info.py             # 游戏信息模型定义
├── services/
│   ├── excel_loader.py          # Excel加载服务
│   ├── excel_analyzer.py        # Excel分析服务
│   ├── task_splitter.py         # 任务拆分服务
│   ├── context_extractor.py     # 上下文提取
│   └── batch_allocator.py       # 批次分配
├── api/
│   ├── analyze_api.py           # 分析API
│   └── task_api.py              # 任务API
├── utils/
│   ├── config_manager.py        # 配置管理
│   └── session_manager.py       # 会话管理
├── tests/
│   ├── test_data/               # 测试数据
│   ├── test_analyzer.py         # 分析器测试
│   └── test_splitter.py         # 拆分器测试
├── main.py                      # 主入口
└── requirements.txt             # 依赖包

```

## 关键代码模块

### 1. 配置文件 (config/config.yaml)
```yaml
llm:
  batch_control:
    max_chars_per_batch: 50000
    max_concurrent_workers: 10

system:
  max_memory_usage: 4096
  log_level: INFO
```

### 2. 任务DataFrame字段定义
```python
# models/task_dataframe.py
TASK_DF_COLUMNS = {
    'task_id': str,
    'batch_id': str,
    'group_id': str,
    'source_lang': 'category',
    'source_text': str,
    'source_context': str,
    'game_context': str,  # 游戏背景信息
    'target_lang': 'category',
    'excel_id': str,
    'sheet_name': str,
    'row_idx': 'int32',
    'col_idx': 'int32',
    'cell_ref': str,
    'status': 'category',
    'priority': 'int8',
    'result': str,
    # ... 其他字段
}

# models/game_info.py
class GameInfo:
    game_type: str       # RPG/FPS/MOBA等
    world_view: str      # 游戏世界观描述
    target_regions: list # ["BR", "TH", "VN"]
    game_style: str      # 写实/卡通/像素等
    additional_context: str # 其他补充信息
```

### 3. API响应格式

#### 分析响应
```json
{
  "session_id": "uuid-xxx",
  "analysis": {
    "file_info": {
      "filename": "test.xlsx",
      "sheets": ["Sheet1"],
      "total_rows": 100,
      "total_cols": 5
    },
    "language_detection": {
      "source_langs": ["CH", "EN"],
      "target_langs": ["PT", "TH", "VN"]
    },
    "statistics": {
      "estimated_tasks": 150,
      "char_distribution": {
        "min": 1,
        "max": 1000,
        "avg": 50
      }
    }
  }
}
```

#### 拆分响应
```json
{
  "session_id": "uuid-xxx",
  "task_count": 150,
  "batch_count": 8,
  "batch_distribution": {
    "PT": 3,
    "TH": 3,
    "VN": 2
  },
  "preview": [
    {
      "task_id": "TASK_0001",
      "source_text": "开始游戏",
      "target_lang": "PT",
      "batch_id": "BATCH_PT_001",
      "group_id": "GROUP_UI_001"
    }
  ],
  "download_url": "/api/tasks/export/uuid-xxx"
}
```

## 验证标准

### 功能验证
- [ ] 能正确加载Excel文件到内存
- [ ] 能接收并处理game_info参数
- [ ] 能识别源语言和目标语言列
- [ ] 能提取颜色和注释信息
- [ ] 能结合游戏信息生成合理的source_context
- [ ] game_context字段正确填充游戏背景信息
- [ ] batch_id按字符数累积正确分配
- [ ] group_id按业务逻辑正确分组
- [ ] 任务DataFrame包含所有必要字段（含game_context）
- [ ] 能导出任务为Excel格式

### 性能验证
- [ ] 1000行Excel处理时间 < 5秒
- [ ] 内存占用合理（< 100MB）
- [ ] batch分配符合max_chars_per_batch限制

### API验证
- [ ] POST /api/analyze/upload 接收Excel和game_info正常响应
- [ ] POST /api/tasks/split 正常响应
- [ ] GET /api/tasks/export/{session_id} 能下载包含game_context的Excel

## 交付物

1. **源代码**：完整的第一阶段代码
2. **测试数据**：4个测试Excel文件
3. **API文档**：Swagger/OpenAPI规范
4. **测试报告**：单元测试和集成测试结果
5. **部署说明**：如何启动服务

## 技术要求

- Python 3.8+
- FastAPI
- pandas >= 1.3.0
- openpyxl >= 3.0.0
- pyyaml
- pytest (测试)

## 注意事项

1. **内存管理**：所有DataFrame保存在内存中，注意内存泄漏
2. **并发安全**：考虑多用户同时上传的情况
3. **错误处理**：Excel格式异常、语言检测失败等
4. **日志记录**：关键操作都要记录日志
5. **代码规范**：遵循PEP8，添加类型注解

## 开发顺序建议

```
Day 1: 任务1.1-1.6（基础框架和数据结构）
Day 2: 任务1.7-1.9（游戏信息处理和Excel分析）
Day 3: 任务1.10-1.14（任务拆分核心）
Day 4: 任务1.15-1.21（API集成和测试）
```