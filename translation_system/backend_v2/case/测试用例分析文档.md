# AI游戏翻译系统 - 测试用例分析文档

## 1. 概述
本文档基于 `AiTranslator.md` 需求规格说明，定义了 AI 游戏翻译系统的完整测试用例集。测试用例覆盖核心功能、辅助功能和高级功能三个维度。

---

## 2. 测试用例分类

### 2.1 核心功能测试用例

#### TC001: 语言识别与翻译路由
**测试目标**: 验证系统能正确识别源语言和目标语言，并选择合适的翻译路由

| 测试场景 | 输入 | 预期输出 | 验证点 |
|---------|------|---------|--------|
| 仅中文源 | Excel含CH列，目标语言JP,KR,VN等 | CH→所有目标语言 | 所有目标语言列都有翻译结果 |
| 中英双源 | Excel含CH和EN列 | CH→亚洲语言(JP,KR,VN,TH,TC)<br>EN→其他语言 | 亚洲语言从中文翻译<br>欧美语言从英文翻译 |
| 源语言缺失 | Excel无可识别源语言 | 错误提示 | 提示"未找到源语言列" |

**测试数据准备**:
```excel
| KEY | CH | EN | JP | KR | FR | TR |
|-----|----|----|----|----|----|----|
| welcome_msg | 欢迎来到游戏 | Welcome to game | | | | |
| start_btn | 开始游戏 | Start Game | | | | |
```

#### TC002: 格式化标记保留
**测试目标**: 验证翻译后保留原有格式化标记

| 格式类型 | 测试文本 | 预期结果 |
|---------|---------|---------|
| HTML标签 | `<font size:12>玩家%s</font>` | 标签和占位符保留 |
| 占位符 | `你获得了{%d}个金币` | 占位符位置正确 |
| 换行符 | `第一行\n第二行` | 换行符保留 |
| 复合格式 | `<H1>标题</H1>\n内容{num}` | 所有格式保留 |

**验证脚本**:
```python
def verify_format_preservation(source, translated):
    # 提取所有格式标记
    import re
    source_formats = re.findall(r'<[^>]+>|{[^}]+}|%[sd]|\\n', source)
    translated_formats = re.findall(r'<[^>]+>|{[^}]+}|%[sd]|\\n', translated)
    return source_formats == translated_formats
```

#### TC003: 颜色标记处理
**测试目标**: 验证系统对颜色标记的特殊处理逻辑

| 标记类型 | 单元格颜色 | 处理逻辑 | 验证方法 |
|---------|-----------|---------|----------|
| 黄色标记 | RGB(255,255,0) | 重新翻译该行 | 比较两次翻译结果 |
| 蓝色标记 | RGB(0,0,255) | 缩短翻译 | 字符数少于原翻译 |
| 无标记 | 白色 | 正常翻译 | 标准翻译流程 |

**测试Excel准备**:
- 使用 openpyxl 设置单元格背景色
- 黄色: `cell.fill = PatternFill(start_color="FFFF00", fill_type="solid")`
- 蓝色: `cell.fill = PatternFill(start_color="0000FF", fill_type="solid")`

#### TC004: 增量翻译逻辑
**测试目标**: 验证系统的智能跳过和增量翻译机制

| 场景 | 源语言 | 目标语言 | 预期行为 |
|------|--------|---------|---------|
| 新增行 | 有内容 | 空 | 翻译该行 |
| 已翻译行 | 有内容 | 有内容 | 跳过该行 |
| 新增语言列 | 有内容 | 整列为空 | 翻译整列 |
| 黄色标记行 | 有内容 | 有内容 | 重新翻译（覆盖） |

#### TC005: 术语表一致性
**测试目标**: 验证术语表在翻译中的应用

**术语表文件** (`terms.json`):
```json
{
  "游戏术语": {
    "CH": {
      "法师": ["Mage", "メイジ", "마법사"],
      "战士": ["Warrior", "戦士", "전사"],
      "金币": ["Gold", "ゴールド", "골드"]
    }
  }
}
```

**测试用例**:
| 原文 | 使用术语表 | 不使用术语表 | 验证点 |
|------|-----------|--------------|--------|
| "法师需要100金币" | Mage needs 100 Gold | Wizard needs 100 coins | 术语一致 |
| "战士和法师组队" | Warrior and Mage team up | Fighter and Wizard team up | 多术语一致 |

#### TC006: 并发翻译性能
**测试目标**: 验证并发翻译的性能和准确性

| 并发数 | 任务数 | 预期时间 | 错误率要求 |
|--------|--------|---------|-----------|
| 1 | 100行 | 基准时间T | <1% |
| 5 | 100行 | <T/3 | <1% |
| 10 | 100行 | <T/5 | <1% |
| 20 | 100行 | <T/8 | <2% |

**性能监控脚本**:
```python
async def test_concurrent_translation(concurrent_level, task_count):
    start_time = time.time()
    tasks = [translate_row(i) for i in range(task_count)]
    results = await asyncio.gather(*tasks, max_concurrent=concurrent_level)
    duration = time.time() - start_time
    error_count = sum(1 for r in results if r.error)
    return {
        'duration': duration,
        'error_rate': error_count / task_count * 100,
        'throughput': task_count / duration
    }
```

---

### 2.2 辅助功能测试用例

#### TC007: 合规性检查
**测试目标**: 验证语言代码识别和表结构一致性检查

| 检查项 | 测试输入 | 预期结果 |
|--------|---------|---------|
| 语言代码识别 | CH, EN, JP, KR, XX | 识别前4个，XX报错 |
| 表结构一致性 | Sheet1: CH,EN,JP<br>Sheet2: CH,EN,KR | 警告：语言列不一致 |
| 非标准命名 | "中文", "English" | 提示规范化建议 |

#### TC008: 翻译进度监控
**测试目标**: 验证实时进度显示和统计

**监控指标**:
- 总任务数: 1000
- 已完成: 实时更新
- 进度百分比: 精确到0.1%
- 预计剩余时间: 基于平均速度计算
- 失败任务: 单独统计和显示

**WebSocket消息格式**:
```json
{
  "type": "progress",
  "data": {
    "total": 1000,
    "completed": 450,
    "failed": 2,
    "current_task": "item_description_042",
    "completion_rate": 45.0,
    "estimated_time_remaining": 120
  }
}
```

---

### 2.3 高级功能测试用例

#### TC009: 批注处理
**测试目标**: 验证单元格批注在翻译中的应用

| 批注内容 | 翻译效果 | 验证方法 |
|---------|---------|---------|
| "这是角色名，保持威严感" | 翻译偏正式 | 人工评估语气 |
| "UI按钮，尽量简短" | 翻译字数减少 | 字符数对比 |
| "Simon: 缩短这句话的翻译" | 触发蓝色标记逻辑 | 长度验证 |

**Excel批注设置**:
```python
from openpyxl.comments import Comment
comment = Comment('这是一个重要的游戏术语', 'GameDesigner')
cell.comment = comment
```

#### TC010: 表名智能识别
**测试目标**: 验证基于表名的翻译策略调整

| 表名 | 翻译策略 | 验证点 |
|------|---------|--------|
| UI_Buttons | UI优化模式 | 翻译简洁 |
| Dialog_NPC | 对话模式 | 保持语气 |
| Item_Description | 描述模式 | 详细准确 |
| Game_Description | 游戏背景 | 作为上下文 |

#### TC011: 项目上下文保持
**测试目标**: 验证项目级别的翻译一致性

**测试流程**:
1. 创建项目，输入游戏背景
2. 第一次翻译10行
3. 第二次翻译新增的10行
4. 验证术语和风格一致性

---

## 3. 边界测试用例

### 3.1 极限测试

#### TC012: 大文件处理
- **文件大小**: 10MB Excel (10000行 x 20列)
- **内存监控**: 不超过2GB
- **处理时间**: <30分钟
- **成功率**: >99%

#### TC013: 长文本处理
- **单格文本**: 5000字符
- **格式保留**: 完整
- **API限制**: 自动分片

#### TC014: 多Sheet处理
- **Sheet数量**: 20个
- **并行处理**: 支持
- **进度独立**: 每个Sheet独立进度

### 3.2 异常测试

#### TC015: 网络异常处理
| 异常类型 | 处理策略 | 验证方法 |
|---------|---------|---------|
| API超时 | 重试3次 | 断网测试 |
| 连接中断 | 断点续传 | 中途断网 |
| 限流 | 自动降速 | 模拟429错误 |

#### TC016: 数据异常处理
| 异常数据 | 预期处理 |
|---------|---------|
| 空单元格 | 跳过 |
| 特殊字符 (emoji) | 保留 |
| 超长文本 | 分段处理 |
| 损坏的Excel | 友好错误提示 |

---

## 4. 集成测试用例

### 4.1 端到端流程测试

#### TC017: 完整翻译流程
```
1. 上传Excel文件 (含3个Sheet, 500行)
2. 系统识别语言 (CH, EN → JP, KR, FR)
3. 加载术语表
4. 输入游戏背景
5. 开始翻译 (并发=5)
6. 监控进度 (WebSocket)
7. 处理异常 (模拟1次API失败)
8. 完成翻译
9. 下载结果
10. 验证质量
```

**验证清单**:
- [ ] 所有目标语言都已翻译
- [ ] 格式标记完整保留
- [ ] 术语翻译一致
- [ ] 黄色/蓝色标记正确处理
- [ ] 已翻译内容未被覆盖
- [ ] 批注内容影响翻译
- [ ] 进度显示准确
- [ ] 错误恢复成功

### 4.2 持久化测试

#### TC018: 断点续传测试
1. 翻译进行到50%
2. 强制中断 (杀进程)
3. 重新启动
4. 自动恢复
5. 继续翻译
6. 验证无重复/遗漏

---

## 5. 性能基准

### 5.1 性能指标

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| 单行翻译延迟 | <2秒 | 单线程测试 |
| 并发吞吐量 | >10行/秒 | 10并发测试 |
| 内存占用 | <1GB/1000行 | 资源监控 |
| CPU使用率 | <80% | 性能监控 |
| 数据库写入 | >100行/秒 | 批量写入测试 |

### 5.2 负载测试

```python
# 负载测试脚本
async def load_test():
    configs = [
        {"users": 1, "rows": 100},
        {"users": 5, "rows": 500},
        {"users": 10, "rows": 1000},
        {"users": 20, "rows": 2000}
    ]

    for config in configs:
        result = await run_concurrent_users(
            user_count=config["users"],
            rows_per_user=config["rows"]
        )
        print(f"Users: {config['users']}, "
              f"Throughput: {result['throughput']:.2f} rows/sec, "
              f"Error Rate: {result['error_rate']:.2f}%")
```

---

## 6. 测试数据准备

### 6.1 测试Excel模板

创建以下测试文件：

1. **basic_test.xlsx** - 基础功能测试
   - 100行游戏文本
   - 包含各种格式标记
   - 多语言列

2. **color_test.xlsx** - 颜色标记测试
   - 黄色标记行: 10行
   - 蓝色标记行: 10行
   - 混合标记: 5行

3. **large_test.xlsx** - 性能测试
   - 5000行数据
   - 10个Sheet
   - 15种语言

4. **special_test.xlsx** - 特殊情况测试
   - 批注: 20个
   - 超长文本: 10行
   - 特殊字符: emoji, 符号

### 6.2 自动化测试框架

```python
# test_framework.py
import pytest
import asyncio
from typing import List, Dict

class TranslationTestFramework:
    """翻译系统测试框架"""

    def __init__(self, api_base_url: str):
        self.api_base_url = api_base_url
        self.session_id = None

    async def upload_file(self, file_path: str) -> str:
        """上传测试文件"""
        # 实现文件上传
        pass

    async def start_translation(self, config: Dict) -> str:
        """开始翻译任务"""
        # 实现翻译启动
        pass

    async def monitor_progress(self) -> Dict:
        """监控翻译进度"""
        # 实现进度监控
        pass

    def verify_results(self, original: str, translated: str) -> bool:
        """验证翻译结果"""
        # 实现结果验证
        pass

# 使用示例
@pytest.mark.asyncio
async def test_basic_translation():
    framework = TranslationTestFramework("http://localhost:8013")

    # 上传文件
    session_id = await framework.upload_file("test_data/basic_test.xlsx")

    # 开始翻译
    await framework.start_translation({
        "session_id": session_id,
        "concurrent": 5,
        "game_context": "这是一个RPG游戏"
    })

    # 监控进度
    while True:
        progress = await framework.monitor_progress()
        if progress['completion_rate'] >= 100:
            break
        await asyncio.sleep(1)

    # 验证结果
    results = await framework.download_results(session_id)
    assert framework.verify_results(original_data, results)
```

---

## 7. 测试执行计划

### 7.1 测试阶段

| 阶段 | 测试内容 | 时长 | 通过标准 |
|------|---------|------|---------|
| 单元测试 | 核心函数 | 1天 | 覆盖率>90% |
| 功能测试 | TC001-TC011 | 3天 | 全部通过 |
| 集成测试 | TC017-TC018 | 2天 | 端到端成功 |
| 性能测试 | 负载测试 | 1天 | 达到基准 |
| 验收测试 | 用户场景 | 2天 | 用户确认 |

### 7.2 缺陷管理

**缺陷分级**:
- P0: 阻塞性问题（系统崩溃、数据丢失）
- P1: 严重问题（功能不可用、翻译错误率>5%）
- P2: 一般问题（性能未达标、UI问题）
- P3: 轻微问题（优化建议）

---

## 8. 测试报告模板

```markdown
# 翻译系统测试报告

## 测试概况
- 测试版本: v2.0.0
- 测试时间: 2024-01-30
- 测试环境: Ubuntu 20.04, Python 3.10

## 测试结果
| 测试类型 | 用例总数 | 通过 | 失败 | 通过率 |
|---------|---------|------|------|--------|
| 功能测试 | 50 | 48 | 2 | 96% |
| 性能测试 | 10 | 9 | 1 | 90% |
| 异常测试 | 15 | 15 | 0 | 100% |

## 关键指标
- 翻译准确率: 98.5%
- 格式保留率: 99.9%
- 并发性能: 12行/秒
- 系统稳定性: 99.5%

## 已知问题
1. [P2] 超长文本(>10000字符)处理较慢
2. [P3] 某些emoji显示异常

## 测试结论
系统满足发布要求，建议修复P2问题后上线。
```

---

## 附录A: 语言代码对照表

| 代码 | 语言 | 代码 | 语言 |
|------|------|------|------|
| CH | 简体中文 | TC | 繁体中文 |
| EN | 英语 | JP | 日语 |
| KR | 韩语 | VN | 越南语 |
| TH | 泰语 | ID | 印尼语 |
| FR | 法语 | DE | 德语 |
| ES | 西班牙语 | PT | 葡萄牙语 |
| RU | 俄语 | TR | 土耳其语 |
| AR | 阿拉伯语 | IT | 意大利语 |

---

## 附录B: 测试工具清单

1. **Excel处理**: openpyxl, pandas
2. **API测试**: pytest, httpx
3. **性能测试**: locust, asyncio
4. **WebSocket测试**: websockets
5. **数据验证**: jsonschema
6. **监控工具**: prometheus, grafana

---

*文档版本: 1.0*
*创建日期: 2024-01-30*
*作者: AI翻译系统测试团队*