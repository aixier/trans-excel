# 翻译源语言和目标语言指定策略方案

## 背景需求

当前系统自动检测源语言和目标语言，但需要支持：
1. 用户指定源语言列（source_langs参数）
2. 源语言列不能作为目标语言列
3. 智能源语言选择规则：
   - 目标语言是亚洲语言（VN/JP/KR/TH/TW）→ 源语言默认CH
   - 目标语言是其他语言 → 源语言优先EN，其次CH

## 方案对比

### 方案一：完全显式控制（推荐）

#### 实现方式
```python
# API参数
source_langs: str = Form(None, description="源语言列表，逗号分隔，如：CH,EN")
target_languages: str = Form(None, description="目标语言列表，逗号分隔")

# 处理逻辑
1. 如果指定了source_langs:
   - 解析为列表，作为源语言列
   - target_languages中排除source_langs
   - 禁用自动检测，严格使用指定的语言

2. 如果未指定source_langs:
   - 根据target_languages智能选择：
     - 亚洲语言目标 → CH为源
     - 其他语言目标 → EN为源（无EN则用CH）

3. 列匹配时严格按指定语言查找
```

#### 优势
- ✅ 逻辑清晰，行为可预测
- ✅ 用户有完全控制权
- ✅ 避免自动检测的误判
- ✅ 支持多源语言场景（如CH+EN同时作为源）
- ✅ API参数简单明了

#### 劣势
- ❌ 用户需要明确知道Excel的列名格式
- ❌ 如果列名不匹配会导致翻译失败
- ❌ 增加了用户使用的复杂度

---

### 方案二：智能优先级模式

#### 实现方式
```python
# API参数
source_priority: str = Form("auto", description="源语言优先级：auto/ch_first/en_first/custom:CH,EN")
target_languages: str = Form(None, description="目标语言列表")
exclude_from_target: bool = Form(True, description="源语言是否排除在目标语言外")

# 处理逻辑
1. 解析source_priority:
   - "auto": 根据目标语言智能判断
   - "ch_first": 优先CH，其次EN
   - "en_first": 优先EN，其次CH
   - "custom:XX,YY": 自定义优先级顺序

2. 逐行动态选择源语言:
   - 按优先级查找有内容的列
   - 找到的第一个作为该行源语言

3. 目标语言处理:
   - 如果exclude_from_target=True，排除源语言
   - 否则源语言也可以作为目标（覆盖场景）
```

#### 优势
- ✅ 更灵活，支持多种使用场景
- ✅ 保留了自动检测能力
- ✅ 逐行判断，适应不完整数据
- ✅ 向后兼容现有逻辑

#### 劣势
- ❌ 逻辑复杂，用户理解成本高
- ❌ 行为可能不一致（不同行用不同源语言）
- ❌ 调试和问题排查困难

---

### 方案三：混合模式（折中方案）

#### 实现方式
```python
# API参数
source_langs: str = Form(None, description="指定源语言，不指定则自动检测")
target_languages: str = Form(None, description="目标语言列表")
strict_mode: bool = Form(False, description="严格模式：True-必须匹配指定语言，False-允许降级")

# 处理逻辑
1. 如果指定了source_langs且strict_mode=True:
   - 严格使用指定的源语言
   - 找不到对应列则报错

2. 如果指定了source_langs且strict_mode=False:
   - 优先使用指定的源语言
   - 找不到时降级到自动检测

3. 如果未指定source_langs:
   - 使用智能规则：
     a. 分析target_languages类型
     b. 亚洲语言→CH优先
     c. 其他语言→EN优先，CH备选

4. 源语言自动从目标语言中排除
```

#### 优势
- ✅ 平衡了控制性和灵活性
- ✅ 容错能力强
- ✅ 新用户友好（默认自动）
- ✅ 高级用户可精确控制

#### 劣势
- ❌ 增加了strict_mode参数
- ❌ 非严格模式下行为可能意外
- ❌ 实现相对复杂

---

## 建议选择

### 推荐：**方案一（完全显式控制）**

**理由：**
1. **明确性**：用户指定什么就用什么，行为完全可预测
2. **简单性**：实现简单，维护成本低
3. **扩展性**：容易添加新的语言支持
4. **调试友好**：出问题时容易定位

### 实现要点
```python
def process_languages(source_langs, target_languages):
    # 1. 解析源语言
    if source_langs:
        source_list = [s.strip().upper() for s in source_langs.split(',')]
    else:
        source_list = None

    # 2. 解析目标语言
    if target_languages:
        target_list = [t.strip().upper() for t in target_languages.split(',')]
    else:
        target_list = None  # 自动检测所有可能的目标

    # 3. 智能源语言选择（当未指定时）
    if not source_list and target_list:
        asian_langs = {'VN', 'JP', 'KR', 'TH', 'TW'}
        if any(t in asian_langs for t in target_list):
            source_list = ['CH']  # 亚洲语言用中文源
        else:
            source_list = ['EN', 'CH']  # 其他语言优先英文

    # 4. 确保源语言不在目标语言中
    if source_list and target_list:
        target_list = [t for t in target_list if t not in source_list]

    return source_list, target_list
```

### 使用示例

1. **亚洲语言翻译**
   ```
   source_langs: 不传（自动选择CH）
   target_languages: "VN,TH,JP"
   → 源：CH，目标：VN,TH,JP
   ```

2. **欧洲语言翻译**
   ```
   source_langs: 不传（自动选择EN）
   target_languages: "FR,DE,ES"
   → 源：EN（优先）/CH（备选），目标：FR,DE,ES
   ```

3. **明确指定**
   ```
   source_langs: "CH,EN"
   target_languages: "PT,TH,IND,VN"
   → 源：CH和EN，目标：PT,TH,IND,VN
   ```

4. **混合场景**
   ```
   source_langs: "EN"
   target_languages: "CH,PT,TH"
   → 源：EN，目标：CH,PT,TH（CH也作为目标）
   ```

## 影响范围

### 需要修改的文件
1. `/api/translation/upload` - 添加source_langs参数
2. `HeaderAnalyzer` - 支持指定源语言列识别
3. `TranslationDetector` - 修改源语言选择逻辑
4. `TranslationEngine` - 传递源语言配置

### 向后兼容性
- 不传source_langs时保持原有逻辑
- 现有API调用不受影响
- 数据库结构无需改动

## 实施计划

1. **第一阶段**：修改API接口，添加source_langs参数
2. **第二阶段**：实现智能源语言选择规则
3. **第三阶段**：修改检测器支持指定源语言
4. **第四阶段**：测试各种场景
5. **第五阶段**：更新API文档

## 风险评估

- **低风险**：API参数可选，不影响现有功能
- **中风险**：列名匹配失败需要友好提示
- **可控**：通过日志详细记录源语言选择过程