<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿»è¯‘æ‰§è¡Œæµ‹è¯• - Translation System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #ff6b6b;
            padding-bottom: 10px;
        }
        .config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, button, textarea {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            font-family: monospace;
        }
        button {
            background: #ff6b6b;
            color: white;
            cursor: pointer;
            font-weight: bold;
            width: auto;
            padding: 10px 20px;
            margin-right: 10px;
        }
        button:hover {
            background: #ff5252;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #5a6268;
        }
        button.warning {
            background: #ffc107;
            color: #333;
        }
        button.warning:hover {
            background: #e0a800;
        }
        .response {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .status.running {
            background: #cfe2ff;
            color: #084298;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .llm-config {
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ ç¿»è¯‘æ‰§è¡Œæµ‹è¯• (Execute Translation)</h1>

    <div class="container">
        <h2>é…ç½®</h2>
        <div class="config">
            <div class="form-group">
                <label>åç«¯åœ°å€ï¼š</label>
                <input type="text" id="apiUrl" value="http://localhost:8013" />
            </div>
        </div>
    </div>

    <div class="container">
        <h2>1. LLMé…ç½®</h2>
        <div class="llm-config">
            <div class="form-group">
                <label>LLM Providerï¼ˆä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„providerï¼‰ï¼š</label>
                <select id="llmProvider">
                    <option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>
                    <option value="openai">OpenAI</option>
                    <option value="gpt-5-nano">GPT-5 Nano</option>
                    <option value="qwen">Qwen</option>
                    <option value="qwen-plus">Qwen Plus</option>
                </select>
            </div>
            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
                <strong>æ³¨æ„ï¼š</strong>LLMé…ç½®éœ€è¦åœ¨åç«¯ config.yaml ä¸­é¢„å…ˆè®¾ç½®ï¼ŒåŒ…æ‹¬ API Keyã€Modelã€Base URL ç­‰ã€‚
                å‰ç«¯åªèƒ½é€‰æ‹©å·²é…ç½®çš„ providerã€‚
            </div>
        </div>
    </div>

    <div class="container">
        <h2>2. å¼€å§‹ç¿»è¯‘</h2>
        <form id="startForm">
            <div class="form-group">
                <label>Session IDï¼š</label>
                <input type="text" id="sessionId" placeholder="ä»ä»»åŠ¡æ‹†è§£é¡µé¢è·å–çš„Session ID" required />
            </div>
            <div class="form-group">
                <label>æœ€å¤§å¹¶å‘æ•°ï¼š</label>
                <input type="number" id="maxConcurrent" value="5" min="1" max="20" />
            </div>
            <button type="submit">å¼€å§‹ç¿»è¯‘</button>
        </form>

        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
        </div>

        <div class="stats-grid" id="executionStats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="statCompleted">0</div>
                <div class="stat-label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPending">0</div>
                <div class="stat-label">å¾…å¤„ç†</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statFailed">0</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statProgress">0%</div>
                <div class="stat-label">è¿›åº¦</div>
            </div>
        </div>

        <h3>æ‰§è¡Œå“åº”ï¼š</h3>
        <div class="response" id="startResponse">ç­‰å¾…å¼€å§‹...</div>

        <h3>å®æ—¶çŠ¶æ€ï¼š</h3>
        <div class="response" id="executionStatus">ç­‰å¾…å¼€å§‹...</div>
    </div>

    <div class="container">
        <h2>3. æ§åˆ¶ç¿»è¯‘</h2>
        <div class="form-group">
            <label>Session IDï¼š</label>
            <input type="text" id="controlSessionId" placeholder="è¾“å…¥Session ID" />
        </div>
        <div class="button-group">
            <button onclick="pauseTranslation()" class="warning">æš‚åœ</button>
            <button onclick="resumeTranslation()" class="secondary">æ¢å¤</button>
            <button onclick="stopTranslation()" style="background: #dc3545;">åœæ­¢</button>
            <button onclick="getStatus()" style="background: #17a2b8;">è·å–çŠ¶æ€</button>
        </div>

        <h3>æ§åˆ¶å“åº”ï¼š</h3>
        <div class="response" id="controlResponse">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const apiUrl = () => document.getElementById('apiUrl').value;
        let statusInterval = null;

        // å¼€å§‹ç¿»è¯‘
        document.getElementById('startForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const sessionId = document.getElementById('sessionId').value;
            const provider = document.getElementById('llmProvider').value;
            const maxWorkers = parseInt(document.getElementById('maxConcurrent').value);

            // å‡†å¤‡è¯·æ±‚ä½“ï¼Œç¬¦åˆåç«¯APIè¦æ±‚
            const requestBody = {
                session_id: sessionId
            };

            // åªæœ‰é€‰æ‹©äº†éé»˜è®¤provideræ—¶æ‰æ·»åŠ 
            if (provider) {
                requestBody.provider = provider;
            }

            // æ·»åŠ max_workerså‚æ•°
            if (maxWorkers && maxWorkers > 0) {
                requestBody.max_workers = maxWorkers;
            }

            try {
                const response = await fetch(`${apiUrl()}/api/execute/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('startResponse').innerHTML =
                        `<span class="status success">ç¿»è¯‘å·²å¼€å§‹!</span>\n\n${JSON.stringify(data, null, 2)}`;

                    // æ˜¾ç¤ºè¿›åº¦æ¡
                    document.getElementById('progressBar').style.display = 'block';
                    document.getElementById('executionStats').style.display = 'grid';

                    // è‡ªåŠ¨å¡«å……æ§åˆ¶è¡¨å•
                    document.getElementById('controlSessionId').value = sessionId;

                    // å¼€å§‹å®šæœŸæ›´æ–°çŠ¶æ€
                    startStatusPolling(sessionId);
                } else {
                    document.getElementById('startResponse').innerHTML =
                        `<span class="status error">å¯åŠ¨å¤±è´¥!</span>\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                document.getElementById('startResponse').innerHTML =
                    `<span class="status error">è¯·æ±‚é”™è¯¯!</span>\n\n${error.message}`;
            }
        });

        // WebSocketè¿æ¥å¯¹è±¡
        let websocket = null;

        // å¼€å§‹çŠ¶æ€è½®è¯¢ï¼ˆå…ˆå¯åŠ¨è½®è¯¢ï¼ŒWebSocketæˆåŠŸåè‡ªåŠ¨åœæ­¢è½®è¯¢ï¼‰
        function startStatusPolling(sessionId) {
            // å…ˆæ¸…é™¤æ—§çš„å®šæ—¶å™¨
            if (statusInterval) {
                clearInterval(statusInterval);
            }

            // ç«‹å³å¯åŠ¨è½®è¯¢ï¼Œç¡®ä¿è¿›åº¦æ˜¾ç¤º
            console.log('Starting polling for session:', sessionId);

            // ç«‹å³è·å–ä¸€æ¬¡çŠ¶æ€
            updateExecutionStatus(sessionId);

            // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
            statusInterval = setInterval(() => {
                updateExecutionStatus(sessionId);
            }, 2000);

            // å°è¯•WebSocketè¿æ¥ï¼ˆæˆåŠŸåä¼šè‡ªåŠ¨åœæ­¢è½®è¯¢ï¼‰
            connectWebSocket(sessionId);
        }

        // WebSocketè¿æ¥å‡½æ•°
        function connectWebSocket(sessionId) {
            try {
                const wsUrl = `ws://localhost:8013/ws/progress/${sessionId}`;
                console.log('Connecting to WebSocket:', wsUrl);

                // å…³é—­æ—§è¿æ¥
                if (websocket) {
                    websocket.close();
                    websocket = null;
                }

                websocket = new WebSocket(wsUrl);

                websocket.onopen = function(event) {
                    console.log('âœ… WebSocket connected for session:', sessionId);

                    // WebSocketè¿æ¥æˆåŠŸï¼Œåœæ­¢è½®è¯¢
                    if (statusInterval) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                        console.log('Stopped polling - using WebSocket');
                    }

                    // æ˜¾ç¤ºWebSocketçŠ¶æ€
                    const statusElement = document.getElementById('executionStatus');
                    if (statusElement && statusElement.innerHTML) {
                        statusElement.innerHTML = '<span style="color: #28a745;">ğŸ”Œ WebSocketå®æ—¶è¿æ¥</span>\n' + statusElement.innerHTML;
                    }

                    // ç¡®ä¿è¿›åº¦æ¡å’Œç»Ÿè®¡æ˜¾ç¤º
                    document.getElementById('progressBar').style.display = 'block';
                    document.getElementById('executionStats').style.display = 'grid';
                };

                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.type === 'progress') {
                            updateProgressFromWebSocket(data.data);
                        } else if (data.type === 'ping') {
                            if (websocket.readyState === WebSocket.OPEN) {
                                websocket.send(JSON.stringify({ type: 'pong' }));
                            }
                        }
                    } catch (e) {
                        console.error('WebSocket message parse error:', e);
                    }
                };

                websocket.onerror = function(error) {
                    console.error('âŒ WebSocket error:', error);
                    websocket = null;

                    // WebSocketå¤±è´¥ï¼Œç¡®ä¿è½®è¯¢ç»§ç»­è¿è¡Œ
                    if (!statusInterval) {
                        console.log('WebSocket failed, ensuring polling continues');
                        statusInterval = setInterval(() => {
                            updateExecutionStatus(sessionId);
                        }, 2000);
                    }
                };

                websocket.onclose = function(event) {
                    console.log('WebSocket closed:', event.code, event.reason);
                    websocket = null;

                    // éæ­£å¸¸å…³é—­ä¸”ä»»åŠ¡æœªå®Œæˆæ—¶ï¼Œç¡®ä¿è½®è¯¢è¿è¡Œ
                    if (event.code !== 1000 && !isTaskCompleted()) {
                        if (!statusInterval) {
                            console.log('WebSocket closed unexpectedly, restarting polling');
                            updateExecutionStatus(sessionId);
                            statusInterval = setInterval(() => {
                                updateExecutionStatus(sessionId);
                            }, 2000);
                        }
                    }
                };

            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
                websocket = null;
                // è¿æ¥å¤±è´¥æ—¶è½®è¯¢å·²ç»åœ¨è¿è¡Œï¼Œæ— éœ€é¢å¤–å¤„ç†
            }
        }

        // ä»WebSocketæ›´æ–°è¿›åº¦
        function updateProgressFromWebSocket(progressData) {
            const { total, completed, processing, pending, failed, completion_rate } = progressData;

            // ä½¿ç”¨completion_rateå¦‚æœæä¾›ï¼Œå¦åˆ™è®¡ç®—
            const progressPercent = completion_rate !== undefined
                ? completion_rate
                : (total > 0 ? (completed / total * 100) : 0);

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('progressFill').style.width = progressPercent + '%';
            document.getElementById('progressFill').textContent = progressPercent.toFixed(1) + '%';

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            document.getElementById('statCompleted').textContent = completed || 0;
            document.getElementById('statPending').textContent = pending || 0;
            document.getElementById('statFailed').textContent = failed || 0;
            document.getElementById('statProgress').textContent = (completion_rate || 0).toFixed(1) + '%';

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusDiv = document.getElementById('executionStatus');
            if (statusDiv) {
                let statusHtml = '<span style="color: #28a745;">ğŸ”Œ WebSocketå®æ—¶æ›´æ–°</span>\n';
                statusHtml += `<span class="status running">æ‰§è¡Œä¸­...</span>\n\n`;
                statusHtml += `ğŸ“Š è¿›åº¦: ${completed}/${total} (${(completion_rate || 0).toFixed(1)}%)\n`;
                statusHtml += `âœ… å·²å®Œæˆ: ${completed}\n`;
                statusHtml += `âš¡ å¤„ç†ä¸­: ${processing}\n`;
                statusHtml += `â³ å¾…å¤„ç†: ${pending}\n`;
                statusHtml += `âŒ å¤±è´¥: ${failed}`;
                statusDiv.innerHTML = statusHtml;

                // ä»»åŠ¡å®Œæˆæ—¶å…³é—­WebSocket
                if (completed === total && total > 0) {
                    if (websocket) {
                        websocket.close(1000, 'Completed');
                    }
                    if (statusInterval) {
                        clearInterval(statusInterval);
                    }
                    statusDiv.innerHTML = `<span class="status success">âœ… ç¿»è¯‘å®Œæˆ!</span>\n\nå·²å®Œæˆ ${completed}/${total} ä¸ªä»»åŠ¡`;
                }
            }
        }

        // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
        function isTaskCompleted() {
            const progressText = document.getElementById('statProgress')?.textContent;
            return progressText && parseFloat(progressText) >= 100;
        }

        // æ›´æ–°æ‰§è¡ŒçŠ¶æ€ï¼ˆè½®è¯¢æ–¹å¼ï¼‰
        async function updateExecutionStatus(sessionId) {
            try {
                const response = await fetch(`${apiUrl()}/api/execute/status/${sessionId}`);
                const data = await response.json();

                console.log('Polling status update:', data);

                if (response.ok) {
                    // ç¡®ä¿è¿›åº¦æ¡å’Œç»Ÿè®¡é¢æ¿æ˜¾ç¤º
                    document.getElementById('progressBar').style.display = 'block';
                    document.getElementById('executionStats').style.display = 'grid';

                    const progress = data.completion_rate || 0;

                    // æ›´æ–°è¿›åº¦æ¡
                    document.getElementById('progressFill').style.width = `${progress}%`;
                    document.getElementById('progressFill').textContent = `${progress.toFixed(1)}%`;

                    // æ›´æ–°ç»Ÿè®¡ - å…¼å®¹ä¸åŒçš„æ•°æ®ç»“æ„
                    const progressData = data.progress || data;
                    document.getElementById('statCompleted').textContent = progressData.completed || 0;
                    document.getElementById('statPending').textContent = progressData.pending || 0;
                    document.getElementById('statFailed').textContent = progressData.failed || 0;
                    document.getElementById('statProgress').textContent = `${progress.toFixed(1)}%`;

                    // æ›´æ–°æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º
                    const statusDiv = document.getElementById('executionStatus');
                    if (statusDiv) {
                        let statusHtml = `<span class="status running">æ‰§è¡Œä¸­...</span>\n\n`;
                        statusHtml += `ğŸ“Š è¿›åº¦: ${progressData.completed || 0}/${progressData.total || 0} (${progress.toFixed(1)}%)\n`;
                        statusHtml += `âœ… å·²å®Œæˆ: ${progressData.completed || 0}\n`;
                        statusHtml += `âš¡ å¤„ç†ä¸­: ${progressData.processing || 0}\n`;
                        statusHtml += `â³ å¾…å¤„ç†: ${progressData.pending || 0}\n`;
                        statusHtml += `âŒ å¤±è´¥: ${progressData.failed || 0}`;
                        statusDiv.innerHTML = statusHtml;
                    }

                    // å¦‚æœå®Œæˆæˆ–åœæ­¢ï¼Œåœæ­¢è½®è¯¢
                    if (data.status === 'completed' || data.status === 'stopped' || progress >= 100) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                        console.log('Task completed, stopped polling');

                        if (statusDiv) {
                            statusDiv.innerHTML = `<span class="status success">âœ… ç¿»è¯‘å®Œæˆ!</span>\n\nå·²å®Œæˆ ${progressData.completed || 0}/${progressData.total || 0} ä¸ªä»»åŠ¡`;
                        }
                    }
                } else {
                    console.error('Status API returned error:', data);
                }
            } catch (error) {
                console.error('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            }
        }

        // æš‚åœç¿»è¯‘
        async function pauseTranslation() {
            const sessionId = document.getElementById('controlSessionId').value;
            if (!sessionId) {
                alert('è¯·è¾“å…¥Session ID');
                return;
            }

            try {
                const response = await fetch(`${apiUrl()}/api/execute/pause/${sessionId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                document.getElementById('controlResponse').innerHTML = response.ok ?
                    `<span class="status warning">å·²æš‚åœ!</span>\n\n${JSON.stringify(data, null, 2)}` :
                    `<span class="status error">æš‚åœå¤±è´¥!</span>\n\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                document.getElementById('controlResponse').innerHTML =
                    `<span class="status error">è¯·æ±‚é”™è¯¯!</span>\n\n${error.message}`;
            }
        }

        // æ¢å¤ç¿»è¯‘
        async function resumeTranslation() {
            const sessionId = document.getElementById('controlSessionId').value;
            if (!sessionId) {
                alert('è¯·è¾“å…¥Session ID');
                return;
            }

            try {
                const response = await fetch(`${apiUrl()}/api/execute/resume/${sessionId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                document.getElementById('controlResponse').innerHTML = response.ok ?
                    `<span class="status success">å·²æ¢å¤!</span>\n\n${JSON.stringify(data, null, 2)}` :
                    `<span class="status error">æ¢å¤å¤±è´¥!</span>\n\n${JSON.stringify(data, null, 2)}`;

                if (response.ok) {
                    startStatusPolling(sessionId);
                }
            } catch (error) {
                document.getElementById('controlResponse').innerHTML =
                    `<span class="status error">è¯·æ±‚é”™è¯¯!</span>\n\n${error.message}`;
            }
        }

        // åœæ­¢ç¿»è¯‘
        async function stopTranslation() {
            const sessionId = document.getElementById('controlSessionId').value;
            if (!sessionId) {
                alert('è¯·è¾“å…¥Session ID');
                return;
            }

            if (!confirm('ç¡®å®šè¦åœæ­¢ç¿»è¯‘å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${apiUrl()}/api/execute/stop/${sessionId}`, {
                    method: 'POST'
                });
                const data = await response.json();

                document.getElementById('controlResponse').innerHTML = response.ok ?
                    `<span class="status error">å·²åœæ­¢!</span>\n\n${JSON.stringify(data, null, 2)}` :
                    `<span class="status error">åœæ­¢å¤±è´¥!</span>\n\n${JSON.stringify(data, null, 2)}`;

                if (response.ok && statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
            } catch (error) {
                document.getElementById('controlResponse').innerHTML =
                    `<span class="status error">è¯·æ±‚é”™è¯¯!</span>\n\n${error.message}`;
            }
        }

        // è·å–çŠ¶æ€
        async function getStatus() {
            const sessionId = document.getElementById('controlSessionId').value;
            if (!sessionId) {
                alert('è¯·è¾“å…¥Session ID');
                return;
            }

            try {
                const response = await fetch(`${apiUrl()}/api/execute/status/${sessionId}`);
                const data = await response.json();

                document.getElementById('controlResponse').innerHTML = response.ok ?
                    `<span class="status running">çŠ¶æ€æ›´æ–°!</span>\n\n${JSON.stringify(data, null, 2)}` :
                    `<span class="status error">æŸ¥è¯¢å¤±è´¥!</span>\n\n${JSON.stringify(data, null, 2)}`;

                if (response.ok) {
                    updateExecutionStatus(sessionId);
                }
            } catch (error) {
                document.getElementById('controlResponse').innerHTML =
                    `<span class="status error">è¯·æ±‚é”™è¯¯!</span>\n\n${error.message}`;
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
        });
    </script>
</body>
</html>