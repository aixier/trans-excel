<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6. æŒä¹…åŒ–ä¸æ£€æŸ¥ç‚¹ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .checkpoint-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
        }

        .checkpoint-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .checkpoint-item:hover {
            background: #eeeeee;
        }

        .checkpoint-item .checkpoint-id {
            font-weight: bold;
            color: #667eea;
        }

        .checkpoint-item .checkpoint-time {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .checkpoint-item .checkpoint-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 14px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: #333;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-inactive {
            background: #9e9e9e;
        }

        .status-error {
            background: #f44336;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-time {
            color: #9cdcfe;
            margin-right: 10px;
        }

        .log-level-info {
            color: #4ec9b0;
        }

        .log-level-warning {
            color: #ce9178;
        }

        .log-level-error {
            color: #f48771;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ æŒä¹…åŒ–ä¸æ£€æŸ¥ç‚¹ç®¡ç†</h1>
            <p>ç®¡ç†ä»»åŠ¡æŒä¹…åŒ–ã€æ£€æŸ¥ç‚¹å’Œæ€§èƒ½ç›‘æ§</p>
        </div>

        <div id="alertMessage" class="alert"></div>

        <!-- æŒä¹…åŒ–çŠ¶æ€ç›‘æ§é¢æ¿ -->
        <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);">
            <h2 style="color: #333; margin-bottom: 20px;">ğŸ” æŒä¹…åŒ–çŠ¶æ€ç›‘æ§</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- æŒä¹…åŒ–é€»è¾‘è¯´æ˜ -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <h3 style="color: #4CAF50; font-size: 16px; margin-bottom: 10px;">âœ… æŒä¹…åŒ–é€»è¾‘</h3>
                    <ul style="font-size: 14px; color: #666; list-style: none; padding: 0; line-height: 1.8;">
                        <li>ğŸ“Œ <strong>ä»»åŠ¡æŒä¹…åŒ–:</strong> æ¯30ç§’è‡ªåŠ¨æ‰¹é‡ä¿å­˜åˆ°MySQL</li>
                        <li>ğŸ“Œ <strong>æ£€æŸ¥ç‚¹å¤‡ä»½:</strong> æ¯60ç§’åˆ›å»ºå®Œæ•´DataFrameå¤‡ä»½</li>
                        <li>ğŸ“Œ <strong>æ‰¹é‡ä¼˜åŒ–:</strong> INSERT ON DUPLICATE KEY UPDATE</li>
                        <li>ğŸ“Œ <strong>äº‹åŠ¡ä¿æŠ¤:</strong> å¤±è´¥è‡ªåŠ¨å›æ»šï¼Œæ•°æ®ä¸€è‡´æ€§ä¿è¯</li>
                    </ul>
                </div>

                <!-- å®æ—¶çŠ¶æ€ -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <h3 style="color: #2196F3; font-size: 16px; margin-bottom: 10px;">ğŸ“Š å®æ—¶çŠ¶æ€</h3>
                    <div style="font-size: 14px; color: #666; line-height: 1.8;">
                        <div>â±ï¸ ä¸Šæ¬¡æŒä¹…åŒ–: <span id="lastPersistTimeStatus" style="font-weight: bold; color: #333;">-</span></div>
                        <div>ğŸ“¦ å¾…ä¿å­˜ä»»åŠ¡: <span id="pendingTasksStatus" style="font-weight: bold; color: #FF9800;">0</span></div>
                        <div>âœ… å·²ä¿å­˜ä»»åŠ¡: <span id="savedTasksStatus" style="font-weight: bold; color: #4CAF50;">0</span></div>
                        <div>âš¡ ä¿å­˜è€—æ—¶: <span id="saveLatencyStatus" style="font-weight: bold; color: #333;">- ms</span></div>
                        <div>â­ï¸ ä¸‹æ¬¡ä¿å­˜: <span id="nextSaveTimeStatus" style="font-weight: bold; color: #2196F3;">-</span></div>
                    </div>
                </div>

                <!-- æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
                    <h3 style="color: #FF9800; font-size: 16px; margin-bottom: 10px;">ğŸ”’ æ•°æ®ä¸€è‡´æ€§</h3>
                    <div style="font-size: 14px; color: #666; line-height: 1.8;">
                        <div>ğŸ’¾ å†…å­˜ä»»åŠ¡æ•°: <span id="memoryTaskCount" style="font-weight: bold; color: #333;">0</span></div>
                        <div>ğŸ—„ï¸ æ•°æ®åº“ä»»åŠ¡æ•°: <span id="dbTaskCount" style="font-weight: bold; color: #333;">0</span></div>
                        <div>ğŸ”„ åŒæ­¥å·®å¼‚: <span id="syncDifference" style="font-weight: bold; color: #4CAF50;">0 (åŒæ­¥)</span></div>
                        <div>ğŸ“Š ä¸€è‡´æ€§çŠ¶æ€: <span id="dataConsistencyStatus" style="font-weight: bold; color: #4CAF50;">âœ… æ­£å¸¸</span></div>
                        <div>ğŸ” æœ€åæ£€æŸ¥: <span id="lastConsistencyCheck" style="font-weight: bold; color: #666;">-</span></div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="btn-group" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="checkPersistenceStatus()" style="flex: 1;">
                    ğŸ” æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€
                </button>
                <button class="btn btn-info" onclick="verifyDataConsistency()" style="flex: 1;">
                    ğŸ”’ éªŒè¯æ•°æ®ä¸€è‡´æ€§
                </button>
                <button class="btn btn-success" onclick="forcePersist()" style="flex: 1;">
                    ğŸ’¾ ç«‹å³æŒä¹…åŒ–
                </button>
                <button class="btn btn-warning" onclick="showPersistenceLogs()" style="flex: 1;">
                    ğŸ“‹ æŸ¥çœ‹æŒä¹…åŒ–æ—¥å¿—
                </button>
            </div>

            <!-- æŒä¹…åŒ–æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="persistenceLogs" style="display: none; margin-top: 20px; background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                <h3 style="color: #666; font-size: 16px; margin-bottom: 10px;">ğŸ“‹ æŒä¹…åŒ–æ—¥å¿—</h3>
                <div id="persistenceLogContent" style="font-family: monospace; font-size: 12px; line-height: 1.5; color: #333;">
                    <!-- æ—¥å¿—å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šæŒä¹…åŒ–æ§åˆ¶ -->
            <div class="card">
                <h2>ğŸ“Š æŒä¹…åŒ–æ§åˆ¶</h2>

                <div class="form-group">
                    <label for="sessionId">ä¼šè¯ ID</label>
                    <input type="text" id="sessionId" placeholder="è¾“å…¥ä¼šè¯ ID">
                </div>

                <div class="form-group">
                    <label>æŒä¹…åŒ–çŠ¶æ€</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="status-indicator status-inactive" id="persistenceStatus"></span>
                        <span id="persistenceStatusText">æœªæ¿€æ´»</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="startPersistence()">
                        å¯åŠ¨æŒä¹…åŒ–
                    </button>
                    <button class="btn btn-danger" onclick="stopPersistence()">
                        åœæ­¢æŒä¹…åŒ–
                    </button>
                    <button class="btn btn-info" onclick="checkPersistenceStatus()">
                        æ£€æŸ¥çŠ¶æ€
                    </button>
                </div>

                <div class="performance-metrics" id="performanceMetrics">
                    <div class="metric-card">
                        <div class="metric-value" id="tasksPersistedCount">0</div>
                        <div class="metric-label">å·²æŒä¹…åŒ–ä»»åŠ¡</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="lastPersistTime">--</div>
                        <div class="metric-label">æœ€åæŒä¹…åŒ–</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="persistInterval">30s</div>
                        <div class="metric-label">æŒä¹…åŒ–é—´éš”</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="dbStatus">âœ“</div>
                        <div class="metric-label">æ•°æ®åº“çŠ¶æ€</div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ£€æŸ¥ç‚¹ç®¡ç† -->
            <div class="card">
                <h2>ğŸ’¾ æ£€æŸ¥ç‚¹ç®¡ç†</h2>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="createCheckpoint()">
                        åˆ›å»ºæ£€æŸ¥ç‚¹
                    </button>
                    <button class="btn btn-warning" onclick="listCheckpoints()">
                        æŸ¥çœ‹æ£€æŸ¥ç‚¹
                    </button>
                    <button class="btn btn-info" onclick="getLatestCheckpoint()">
                        æœ€æ–°æ£€æŸ¥ç‚¹
                    </button>
                </div>

                <div class="checkpoint-list" id="checkpointList">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        æš‚æ— æ£€æŸ¥ç‚¹æ•°æ®
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label for="restoreCheckpointId">æ¢å¤æ£€æŸ¥ç‚¹ ID</label>
                    <input type="text" id="restoreCheckpointId" placeholder="ç•™ç©ºæ¢å¤æœ€æ–°æ£€æŸ¥ç‚¹">
                </div>

                <button class="btn btn-warning" onclick="restoreCheckpoint()">
                    æ¢å¤æ£€æŸ¥ç‚¹
                </button>
            </div>
        </div>

        <!-- æ€§èƒ½ç›‘æ§é¢æ¿ -->
        <div class="card">
            <h2>ğŸ“ˆ æ€§èƒ½ç›‘æ§</h2>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="startMonitoring()">
                    å¼€å§‹ç›‘æ§
                </button>
                <button class="btn btn-danger" onclick="stopMonitoring()">
                    åœæ­¢ç›‘æ§
                </button>
                <button class="btn btn-info" onclick="getPerformanceMetrics()">
                    è·å–æŒ‡æ ‡
                </button>
            </div>

            <div class="performance-metrics" id="systemMetrics">
                <div class="metric-card">
                    <div class="metric-value" id="cpuUsage">0%</div>
                    <div class="metric-label">CPU ä½¿ç”¨ç‡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="memoryUsage">0%</div>
                    <div class="metric-label">å†…å­˜ä½¿ç”¨ç‡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="activeSessions">0</div>
                    <div class="metric-label">æ´»åŠ¨ä¼šè¯</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="threadCount">0</div>
                    <div class="metric-label">çº¿ç¨‹æ•°</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="taskThroughput">0/m</div>
                    <div class="metric-label">ä»»åŠ¡ååé‡</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="errorRate">0%</div>
                    <div class="metric-label">é”™è¯¯ç‡</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">
                    0%
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—æŸ¥çœ‹å™¨ -->
        <div class="card">
            <h2>ğŸ“ å®æ—¶æ—¥å¿—</h2>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="startLogStreaming()">
                    å¼€å§‹æ—¥å¿—æµ
                </button>
                <button class="btn btn-danger" onclick="stopLogStreaming()">
                    åœæ­¢æ—¥å¿—æµ
                </button>
                <button class="btn btn-warning" onclick="clearLogs()">
                    æ¸…ç©ºæ—¥å¿—
                </button>
            </div>

            <div class="log-viewer" id="logViewer">
                <div class="log-entry">
                    <span class="log-time">00:00:00</span>
                    <span class="log-level-info">INFO</span> ç­‰å¾…æ—¥å¿—æ•°æ®...
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px;">å¤„ç†ä¸­...</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8013/api';
        let monitoringInterval = null;
        let logStreamingInterval = null;
        let currentSessionId = null;

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';

            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // è·å–ä¼šè¯ID
        function getSessionId() {
            const sessionId = document.getElementById('sessionId').value;
            if (!sessionId) {
                showMessage('è¯·è¾“å…¥ä¼šè¯ID', 'error');
                return null;
            }
            currentSessionId = sessionId;
            return sessionId;
        }

        // å¯åŠ¨æŒä¹…åŒ–
        async function startPersistence() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/execute/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updatePersistenceStatus(true);
                showMessage('æŒä¹…åŒ–å·²å¯åŠ¨', 'success');
                addLog('INFO', 'æŒä¹…åŒ–æœåŠ¡å·²å¯åŠ¨');
            } catch (error) {
                showMessage('å¯åŠ¨æŒä¹…åŒ–å¤±è´¥: ' + error.message, 'error');
                addLog('ERROR', 'å¯åŠ¨æŒä¹…åŒ–å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åœæ­¢æŒä¹…åŒ–
        async function stopPersistence() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/execute/stop/${sessionId}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updatePersistenceStatus(false);
                showMessage('æŒä¹…åŒ–å·²åœæ­¢', 'success');
                addLog('INFO', 'æŒä¹…åŒ–æœåŠ¡å·²åœæ­¢');
            } catch (error) {
                showMessage('åœæ­¢æŒä¹…åŒ–å¤±è´¥: ' + error.message, 'error');
                addLog('ERROR', 'åœæ­¢æŒä¹…åŒ–å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€
        async function checkPersistenceStatus() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/execute/status/${sessionId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const isActive = data.status === 'executing';
                updatePersistenceStatus(isActive);

                // æ›´æ–°æŒ‡æ ‡
                if (data.task_count) {
                    document.getElementById('tasksPersistedCount').textContent = data.completed_tasks || 0;
                }

                showMessage(`æŒä¹…åŒ–çŠ¶æ€: ${isActive ? 'æ´»åŠ¨' : 'æœªæ¿€æ´»'}`, 'info');
                addLog('INFO', `æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€: ${isActive ? 'æ´»åŠ¨' : 'æœªæ¿€æ´»'}`);
            } catch (error) {
                showMessage('æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
                addLog('ERROR', 'æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°æŒä¹…åŒ–çŠ¶æ€æ˜¾ç¤º
        function updatePersistenceStatus(isActive) {
            const statusIndicator = document.getElementById('persistenceStatus');
            const statusText = document.getElementById('persistenceStatusText');

            if (isActive) {
                statusIndicator.className = 'status-indicator status-active';
                statusText.textContent = 'æ´»åŠ¨ä¸­';
                document.getElementById('lastPersistTime').textContent = new Date().toLocaleTimeString('zh-CN');
            } else {
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = 'æœªæ¿€æ´»';
            }
        }

        // åˆ›å»ºæ£€æŸ¥ç‚¹
        async function createCheckpoint() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/execute/checkpoint/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ checkpoint_type: 'manual' })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                showMessage('æ£€æŸ¥ç‚¹åˆ›å»ºæˆåŠŸ', 'success');
                addLog('INFO', `åˆ›å»ºæ£€æŸ¥ç‚¹: ${data.checkpoint_id}`);
                listCheckpoints();
            } catch (error) {
                showMessage('åˆ›å»ºæ£€æŸ¥ç‚¹å¤±è´¥: ' + error.message, 'error');
                addLog('ERROR', 'åˆ›å»ºæ£€æŸ¥ç‚¹å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // åˆ—å‡ºæ£€æŸ¥ç‚¹
        async function listCheckpoints() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                // æ¨¡æ‹Ÿæ£€æŸ¥ç‚¹æ•°æ®ï¼Œå®é™…åº”è¯¥ä»APIè·å–
                const checkpoints = [
                    {
                        checkpoint_id: '20240130_143022',
                        checkpoint_type: 'auto',
                        created_at: '2024-01-30 14:30:22',
                        progress_data: {
                            total_tasks: 1000,
                            completed_tasks: 750,
                            completion_rate: 75
                        }
                    },
                    {
                        checkpoint_id: '20240130_142522',
                        checkpoint_type: 'manual',
                        created_at: '2024-01-30 14:25:22',
                        progress_data: {
                            total_tasks: 1000,
                            completed_tasks: 500,
                            completion_rate: 50
                        }
                    }
                ];

                displayCheckpoints(checkpoints);
                addLog('INFO', `è·å–åˆ° ${checkpoints.length} ä¸ªæ£€æŸ¥ç‚¹`);
            } catch (error) {
                showMessage('è·å–æ£€æŸ¥ç‚¹å¤±è´¥: ' + error.message, 'error');
                addLog('ERROR', 'è·å–æ£€æŸ¥ç‚¹å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ£€æŸ¥ç‚¹åˆ—è¡¨
        function displayCheckpoints(checkpoints) {
            const listDiv = document.getElementById('checkpointList');
            if (!checkpoints || checkpoints.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ£€æŸ¥ç‚¹æ•°æ®</div>';
                return;
            }

            listDiv.innerHTML = checkpoints.map(cp => `
                <div class="checkpoint-item">
                    <div class="checkpoint-id">ID: ${cp.checkpoint_id}</div>
                    <div class="checkpoint-time">åˆ›å»ºæ—¶é—´: ${cp.created_at}</div>
                    <div class="checkpoint-stats">
                        <div class="stat-item">
                            <span class="stat-label">ç±»å‹:</span>
                            <span class="stat-value">${cp.checkpoint_type}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å®Œæˆ:</span>
                            <span class="stat-value">${cp.progress_data.completed_tasks}/${cp.progress_data.total_tasks}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">è¿›åº¦:</span>
                            <span class="stat-value">${cp.progress_data.completion_rate}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // è·å–æœ€æ–°æ£€æŸ¥ç‚¹
        async function getLatestCheckpoint() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                // æ¨¡æ‹Ÿè·å–æœ€æ–°æ£€æŸ¥ç‚¹
                const latest = {
                    checkpoint_id: '20240130_143022',
                    checkpoint_type: 'auto',
                    created_at: '2024-01-30 14:30:22',
                    progress_data: {
                        total_tasks: 1000,
                        completed_tasks: 750,
                        completion_rate: 75
                    }
                };

                displayCheckpoints([latest]);
                showMessage('å·²è·å–æœ€æ–°æ£€æŸ¥ç‚¹', 'info');
                addLog('INFO', `æœ€æ–°æ£€æŸ¥ç‚¹: ${latest.checkpoint_id}`);
            } catch (error) {
                showMessage('è·å–æœ€æ–°æ£€æŸ¥ç‚¹å¤±è´¥: ' + error.message, 'error');
                addLog('ERROR', 'è·å–æœ€æ–°æ£€æŸ¥ç‚¹å¤±è´¥: ' + error.message);
            }
        }

        // æ¢å¤æ£€æŸ¥ç‚¹
        async function restoreCheckpoint() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            const checkpointId = document.getElementById('restoreCheckpointId').value;

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/execute/checkpoint/restore/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ checkpoint_id: checkpointId || null })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                showMessage('æ£€æŸ¥ç‚¹æ¢å¤æˆåŠŸ', 'success');
                addLog('INFO', `æ¢å¤æ£€æŸ¥ç‚¹: ${checkpointId || 'æœ€æ–°'}`);
            } catch (error) {
                showMessage('æ¢å¤æ£€æŸ¥ç‚¹å¤±è´¥: ' + error.message, 'error');
                addLog('ERROR', 'æ¢å¤æ£€æŸ¥ç‚¹å¤±è´¥: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // å¼€å§‹æ€§èƒ½ç›‘æ§
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }

            showMessage('æ€§èƒ½ç›‘æ§å·²å¯åŠ¨', 'success');
            addLog('INFO', 'å¯åŠ¨æ€§èƒ½ç›‘æ§');

            // ç«‹å³è·å–ä¸€æ¬¡
            getPerformanceMetrics();

            // å®šæœŸæ›´æ–°
            monitoringInterval = setInterval(getPerformanceMetrics, 5000);
        }

        // åœæ­¢æ€§èƒ½ç›‘æ§
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            showMessage('æ€§èƒ½ç›‘æ§å·²åœæ­¢', 'info');
            addLog('INFO', 'åœæ­¢æ€§èƒ½ç›‘æ§');
        }

        // è·å–æ€§èƒ½æŒ‡æ ‡
        async function getPerformanceMetrics() {
            try {
                // æ¨¡æ‹Ÿæ€§èƒ½æ•°æ®ï¼Œå®é™…åº”è¯¥ä»APIè·å–
                const metrics = {
                    cpu_percent: Math.random() * 100,
                    memory_percent: Math.random() * 100,
                    active_sessions: Math.floor(Math.random() * 10),
                    thread_count: Math.floor(Math.random() * 50) + 10,
                    throughput: Math.floor(Math.random() * 100),
                    error_rate: Math.random() * 10
                };

                updatePerformanceMetrics(metrics);
            } catch (error) {
                console.error('è·å–æ€§èƒ½æŒ‡æ ‡å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ€§èƒ½æŒ‡æ ‡æ˜¾ç¤º
        function updatePerformanceMetrics(metrics) {
            document.getElementById('cpuUsage').textContent = `${metrics.cpu_percent.toFixed(1)}%`;
            document.getElementById('memoryUsage').textContent = `${metrics.memory_percent.toFixed(1)}%`;
            document.getElementById('activeSessions').textContent = metrics.active_sessions;
            document.getElementById('threadCount').textContent = metrics.thread_count;
            document.getElementById('taskThroughput').textContent = `${metrics.throughput}/m`;
            document.getElementById('errorRate').textContent = `${metrics.error_rate.toFixed(1)}%`;

            // æ›´æ–°è¿›åº¦æ¡
            const progress = metrics.memory_percent;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress.toFixed(1)}%`;
        }

        // å¼€å§‹æ—¥å¿—æµ
        function startLogStreaming() {
            if (logStreamingInterval) {
                clearInterval(logStreamingInterval);
            }

            showMessage('æ—¥å¿—æµå·²å¯åŠ¨', 'success');

            // æ‰§è¡ŒçœŸå®çš„åç«¯æ“ä½œå¹¶è®°å½•è¯¦ç»†æ—¥å¿—
            const sessionId = getSessionId();
            if (!sessionId) {
                addLog('ERROR', 'æ— æ³•å¼€å§‹æ—¥å¿—æµï¼šç¼ºå°‘Session ID');
                return;
            }

            // å®šæœŸæ‰§è¡Œå®é™…æ“ä½œå¹¶è®°å½•è¯¦ç»†é”™è¯¯
            logStreamingInterval = setInterval(async () => {
                try {
                    // 1. æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€
                    addLog('INFO', 'æ­£åœ¨æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€...');
                    const statusResponse = await fetch(`${API_BASE_URL}/monitor/status/${sessionId}`);
                    if (!statusResponse.ok) {
                        const errorData = await statusResponse.json().catch(() => ({}));
                        addLog('ERROR', `æŒä¹…åŒ–çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${statusResponse.status} - ${errorData.detail || statusResponse.statusText}`);
                    } else {
                        const statusData = await statusResponse.json();
                        addLog('INFO', `æŒä¹…åŒ–çŠ¶æ€: å·²ä¿å­˜ ${statusData.persisted_count || 0} ä¸ªä»»åŠ¡`);
                    }

                    // 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
                    const poolResponse = await fetch(`${API_BASE_URL}/pool/stats`);
                    if (!poolResponse.ok) {
                        const errorData = await poolResponse.json().catch(() => ({}));
                        addLog('ERROR', `è¿æ¥æ± çŠ¶æ€è·å–å¤±è´¥: ${poolResponse.status} - ${errorData.detail || poolResponse.statusText}`);
                    } else {
                        const poolData = await poolResponse.json();
                        const poolStats = poolData.pool_stats || {};
                        if (poolStats.health === 'critical') {
                            addLog('ERROR', `æ•°æ®åº“è¿æ¥æ± ä¸¥é‡é—®é¢˜: ä½¿ç”¨ç‡ ${poolStats.usage_percent}%, ç©ºé—²è¿æ¥: ${poolStats.free}`);
                        } else if (poolStats.health === 'warning') {
                            addLog('WARNING', `æ•°æ®åº“è¿æ¥æ± è­¦å‘Š: ä½¿ç”¨ç‡ ${poolStats.usage_percent}%`);
                        } else {
                            addLog('INFO', `è¿æ¥æ± æ­£å¸¸: ${poolStats.in_use}/${poolStats.max_size} è¿æ¥ä½¿ç”¨ä¸­`);
                        }
                    }

                    // 3. å°è¯•åˆ›å»ºæ£€æŸ¥ç‚¹
                    const checkpointResponse = await fetch(`${API_BASE_URL}/execute/checkpoint/${sessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ checkpoint_type: 'auto' })
                    });

                    if (!checkpointResponse.ok) {
                        const errorData = await checkpointResponse.json().catch(() => ({}));
                        addLog('ERROR', `æ£€æŸ¥ç‚¹åˆ›å»ºå¤±è´¥: ${checkpointResponse.status} - ${errorData.detail || checkpointResponse.statusText}`);
                    } else {
                        const checkpointData = await checkpointResponse.json();
                        addLog('INFO', `æ£€æŸ¥ç‚¹åˆ›å»ºæˆåŠŸ: ${checkpointData.checkpoint_id || 'unknown'}`);
                    }

                } catch (networkError) {
                    addLog('ERROR', `ç½‘ç»œé”™è¯¯: ${networkError.message}`);
                    addLog('WARNING', 'è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ (http://localhost:8013)');
                }
            }, 5000);
        }

        // åœæ­¢æ—¥å¿—æµ
        function stopLogStreaming() {
            if (logStreamingInterval) {
                clearInterval(logStreamingInterval);
                logStreamingInterval = null;
            }
            showMessage('æ—¥å¿—æµå·²åœæ­¢', 'info');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logViewer').innerHTML = '';
            showMessage('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLog(level, message) {
            const logViewer = document.getElementById('logViewer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const time = new Date().toLocaleTimeString('zh-CN');
            const levelClass = `log-level-${level.toLowerCase()}`;

            logEntry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="${levelClass}">${level}</span> ${message}
            `;

            logViewer.appendChild(logEntry);

            // ä¿æŒæœ€æ–°æ—¥å¿—å¯è§
            logViewer.scrollTop = logViewer.scrollHeight;

            // é™åˆ¶æ—¥å¿—æ¡æ•°
            if (logViewer.children.length > 100) {
                logViewer.removeChild(logViewer.firstChild);
            }
        }

        // ==================== æŒä¹…åŒ–çŠ¶æ€ç›‘æ§åŠŸèƒ½ ====================

        // æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€
        async function checkPersistenceStatus() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                addLog('INFO', 'æ­£åœ¨æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€...');

                // è·å–ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ï¼ˆåŒ…å«æŒä¹…åŒ–ä¿¡æ¯ï¼‰
                const response = await fetch(`${API_BASE_URL}/monitor/status/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();

                    // æ›´æ–°å®æ—¶çŠ¶æ€æ˜¾ç¤º
                    const total = data.progress?.total || 0;
                    const completed = data.progress?.completed || 0;
                    const pending = data.progress?.pending || 0;

                    document.getElementById('savedTasksStatus').textContent = completed;
                    document.getElementById('pendingTasksStatus').textContent = pending;

                    // æ¨¡æ‹ŸæŒä¹…åŒ–æ—¶é—´ï¼ˆå®é™…åº”ä»åç«¯è·å–ï¼‰
                    const now = new Date();
                    document.getElementById('lastPersistTimeStatus').textContent = now.toLocaleTimeString();

                    // è®¡ç®—ä¸‹æ¬¡ä¿å­˜æ—¶é—´ï¼ˆ30ç§’åï¼‰
                    const nextTime = new Date(now.getTime() + 30000);
                    document.getElementById('nextSaveTimeStatus').textContent = nextTime.toLocaleTimeString();

                    addLog('INFO', `æŒä¹…åŒ–çŠ¶æ€: æ€»ä»»åŠ¡ ${total}ï¼Œå·²å®Œæˆ ${completed}ï¼Œå¾…å¤„ç† ${pending}`);
                } else {
                    addLog('ERROR', `è·å–çŠ¶æ€å¤±è´¥: HTTP ${response.status}`);
                }

            } catch (error) {
                addLog('ERROR', `æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€å¤±è´¥: ${error.message}`);
            }
        }

        // éªŒè¯æ•°æ®ä¸€è‡´æ€§
        async function verifyDataConsistency() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                addLog('INFO', 'æ­£åœ¨éªŒè¯æ•°æ®ä¸€è‡´æ€§...');

                // è·å–å†…å­˜å’Œæ•°æ®åº“ä»»åŠ¡æ•°å¯¹æ¯”
                const response = await fetch(`${API_BASE_URL}/monitor/summary/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();

                    const total = data.task_statistics?.total || 0;
                    const dbTasks = data.task_statistics?.by_status?.completed || 0;

                    document.getElementById('memoryTaskCount').textContent = total;
                    document.getElementById('dbTaskCount').textContent = dbTasks;

                    const difference = Math.abs(total - dbTasks);
                    const syncElement = document.getElementById('syncDifference');
                    const statusElement = document.getElementById('dataConsistencyStatus');

                    if (difference === 0) {
                        syncElement.textContent = '0 (å®Œå…¨åŒæ­¥)';
                        syncElement.style.color = '#4CAF50';
                        statusElement.textContent = 'âœ… æ•°æ®ä¸€è‡´';
                        statusElement.style.color = '#4CAF50';
                        addLog('INFO', 'âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡');
                    } else if (difference <= 10) {
                        syncElement.textContent = `${difference} (è½»å¾®å»¶è¿Ÿ)`;
                        syncElement.style.color = '#FF9800';
                        statusElement.textContent = 'âš ï¸ è½»å¾®ä¸åŒæ­¥';
                        statusElement.style.color = '#FF9800';
                        addLog('WARNING', `âš ï¸ è½»å¾®ä¸åŒæ­¥: å·®å¼‚ ${difference} ä¸ªä»»åŠ¡`);
                    } else {
                        syncElement.textContent = `${difference} (ä¸¥é‡ä¸åŒæ­¥)`;
                        syncElement.style.color = '#F44336';
                        statusElement.textContent = 'âŒ æ•°æ®ä¸ä¸€è‡´';
                        statusElement.style.color = '#F44336';
                        addLog('ERROR', `âŒ æ•°æ®ä¸ä¸€è‡´: å·®å¼‚ ${difference} ä¸ªä»»åŠ¡`);
                    }

                    document.getElementById('lastConsistencyCheck').textContent = new Date().toLocaleTimeString();
                }
            } catch (error) {
                addLog('ERROR', `éªŒè¯å¤±è´¥: ${error.message}`);
            }
        }

        // å¼ºåˆ¶ç«‹å³æŒä¹…åŒ–
        async function forcePersist() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                showLoading(true);
                addLog('INFO', 'æ‰§è¡Œå¼ºåˆ¶æŒä¹…åŒ–...');

                // åˆ›å»ºæ‰‹åŠ¨æ£€æŸ¥ç‚¹ï¼ˆè§¦å‘æŒä¹…åŒ–ï¼‰
                const response = await fetch(`${API_BASE_URL}/execute/checkpoint/${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checkpoint_type: 'manual' })
                });

                if (response.ok) {
                    const data = await response.json();
                    addLog('INFO', `âœ… æŒä¹…åŒ–æˆåŠŸ: ${data.checkpoint_id}`);
                    showMessage('å¼ºåˆ¶æŒä¹…åŒ–æˆåŠŸ', 'success');

                    // æ›´æ–°çŠ¶æ€
                    await checkPersistenceStatus();
                    await verifyDataConsistency();
                } else {
                    const error = await response.json();
                    addLog('ERROR', `æŒä¹…åŒ–å¤±è´¥: ${error.detail}`);
                }
            } catch (error) {
                addLog('ERROR', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºæŒä¹…åŒ–æ—¥å¿—
        function showPersistenceLogs() {
            const logsDiv = document.getElementById('persistenceLogs');
            logsDiv.style.display = logsDiv.style.display === 'none' ? 'block' : 'none';

            if (logsDiv.style.display === 'block') {
                updatePersistenceLogs();
            }
        }

        // æ›´æ–°æŒä¹…åŒ–æ—¥å¿—
        function updatePersistenceLogs() {
            const logContent = document.getElementById('persistenceLogContent');
            const logs = [];

            // æ”¶é›†æŒä¹…åŒ–ç›¸å…³æ—¥å¿—
            const logEntries = document.querySelectorAll('#logViewer .log-entry');
            logEntries.forEach(entry => {
                if (entry.textContent.includes('æŒä¹…åŒ–') ||
                    entry.textContent.includes('ä¿å­˜') ||
                    entry.textContent.includes('æ£€æŸ¥ç‚¹')) {
                    logs.push(entry.innerHTML);
                }
            });

            logContent.innerHTML = logs.length > 0 ?
                logs.slice(-20).join('<br>') :
                '<span style="color: #999;">æš‚æ— æŒä¹…åŒ–æ—¥å¿—</span>';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å°è¯•ä»localStorageè¯»å–ä¸Šæ¬¡çš„sessionId
            const savedSessionId = localStorage.getItem('lastSessionId');
            if (savedSessionId) {
                document.getElementById('sessionId').value = savedSessionId;
            }

            // ä¿å­˜sessionIdåˆ°localStorage
            document.getElementById('sessionId').addEventListener('change', function() {
                localStorage.setItem('lastSessionId', this.value);
            });

            // åˆå§‹æ—¥å¿—
            addLog('INFO', 'æŒä¹…åŒ–ç®¡ç†ç•Œé¢å·²åŠ è½½');
            addLog('INFO', 'ç­‰å¾…ç”¨æˆ·æ“ä½œ...');

            // è‡ªåŠ¨æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€ï¼ˆå¦‚æœæœ‰session IDï¼‰
            if (savedSessionId) {
                setTimeout(() => {
                    checkPersistenceStatus();
                    verifyDataConsistency();
                }, 1000);
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            if (logStreamingInterval) {
                clearInterval(logStreamingInterval);
            }
        });
    </script>
</body>
</html>