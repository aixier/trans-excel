<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6. 持久化与检查点管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .checkpoint-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
        }

        .checkpoint-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .checkpoint-item:hover {
            background: #eeeeee;
        }

        .checkpoint-item .checkpoint-id {
            font-weight: bold;
            color: #667eea;
        }

        .checkpoint-item .checkpoint-time {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        .checkpoint-item .checkpoint-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 14px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            color: #333;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-inactive {
            background: #9e9e9e;
        }

        .status-error {
            background: #f44336;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-time {
            color: #9cdcfe;
            margin-right: 10px;
        }

        .log-level-info {
            color: #4ec9b0;
        }

        .log-level-warning {
            color: #ce9178;
        }

        .log-level-error {
            color: #f48771;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 持久化与检查点管理</h1>
            <p>管理任务持久化、检查点和性能监控</p>
        </div>

        <div id="alertMessage" class="alert"></div>

        <!-- 持久化状态监控面板 -->
        <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);">
            <h2 style="color: #333; margin-bottom: 20px;">🔍 持久化状态监控</h2>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- 持久化逻辑说明 -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <h3 style="color: #4CAF50; font-size: 16px; margin-bottom: 10px;">✅ 持久化逻辑</h3>
                    <ul style="font-size: 14px; color: #666; list-style: none; padding: 0; line-height: 1.8;">
                        <li>📌 <strong>任务持久化:</strong> 每30秒自动批量保存到MySQL</li>
                        <li>📌 <strong>检查点备份:</strong> 每60秒创建完整DataFrame备份</li>
                        <li>📌 <strong>批量优化:</strong> INSERT ON DUPLICATE KEY UPDATE</li>
                        <li>📌 <strong>事务保护:</strong> 失败自动回滚，数据一致性保证</li>
                    </ul>
                </div>

                <!-- 实时状态 -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <h3 style="color: #2196F3; font-size: 16px; margin-bottom: 10px;">📊 实时状态</h3>
                    <div style="font-size: 14px; color: #666; line-height: 1.8;">
                        <div>⏱️ 上次持久化: <span id="lastPersistTimeStatus" style="font-weight: bold; color: #333;">-</span></div>
                        <div>📦 待保存任务: <span id="pendingTasksStatus" style="font-weight: bold; color: #FF9800;">0</span></div>
                        <div>✅ 已保存任务: <span id="savedTasksStatus" style="font-weight: bold; color: #4CAF50;">0</span></div>
                        <div>⚡ 保存耗时: <span id="saveLatencyStatus" style="font-weight: bold; color: #333;">- ms</span></div>
                        <div>⏭️ 下次保存: <span id="nextSaveTimeStatus" style="font-weight: bold; color: #2196F3;">-</span></div>
                    </div>
                </div>

                <!-- 数据一致性检查 -->
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #FF9800;">
                    <h3 style="color: #FF9800; font-size: 16px; margin-bottom: 10px;">🔒 数据一致性</h3>
                    <div style="font-size: 14px; color: #666; line-height: 1.8;">
                        <div>💾 内存任务数: <span id="memoryTaskCount" style="font-weight: bold; color: #333;">0</span></div>
                        <div>🗄️ 数据库任务数: <span id="dbTaskCount" style="font-weight: bold; color: #333;">0</span></div>
                        <div>🔄 同步差异: <span id="syncDifference" style="font-weight: bold; color: #4CAF50;">0 (同步)</span></div>
                        <div>📊 一致性状态: <span id="dataConsistencyStatus" style="font-weight: bold; color: #4CAF50;">✅ 正常</span></div>
                        <div>🔍 最后检查: <span id="lastConsistencyCheck" style="font-weight: bold; color: #666;">-</span></div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="btn-group" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="checkPersistenceStatus()" style="flex: 1;">
                    🔍 检查持久化状态
                </button>
                <button class="btn btn-info" onclick="verifyDataConsistency()" style="flex: 1;">
                    🔒 验证数据一致性
                </button>
                <button class="btn btn-success" onclick="forcePersist()" style="flex: 1;">
                    💾 立即持久化
                </button>
                <button class="btn btn-warning" onclick="showPersistenceLogs()" style="flex: 1;">
                    📋 查看持久化日志
                </button>
            </div>

            <!-- 持久化日志显示区域 -->
            <div id="persistenceLogs" style="display: none; margin-top: 20px; background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                <h3 style="color: #666; font-size: 16px; margin-bottom: 10px;">📋 持久化日志</h3>
                <div id="persistenceLogContent" style="font-family: monospace; font-size: 12px; line-height: 1.5; color: #333;">
                    <!-- 日志内容将在这里显示 -->
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- 左侧：持久化控制 -->
            <div class="card">
                <h2>📊 持久化控制</h2>

                <div class="form-group">
                    <label for="sessionId">会话 ID</label>
                    <input type="text" id="sessionId" placeholder="输入会话 ID">
                </div>

                <div class="form-group">
                    <label>持久化状态</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="status-indicator status-inactive" id="persistenceStatus"></span>
                        <span id="persistenceStatusText">未激活</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="startPersistence()">
                        启动持久化
                    </button>
                    <button class="btn btn-danger" onclick="stopPersistence()">
                        停止持久化
                    </button>
                    <button class="btn btn-info" onclick="checkPersistenceStatus()">
                        检查状态
                    </button>
                </div>

                <div class="performance-metrics" id="performanceMetrics">
                    <div class="metric-card">
                        <div class="metric-value" id="tasksPersistedCount">0</div>
                        <div class="metric-label">已持久化任务</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="lastPersistTime">--</div>
                        <div class="metric-label">最后持久化</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="persistInterval">30s</div>
                        <div class="metric-label">持久化间隔</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="dbStatus">✓</div>
                        <div class="metric-label">数据库状态</div>
                    </div>
                </div>
            </div>

            <!-- 右侧：检查点管理 -->
            <div class="card">
                <h2>💾 检查点管理</h2>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="createCheckpoint()">
                        创建检查点
                    </button>
                    <button class="btn btn-warning" onclick="listCheckpoints()">
                        查看检查点
                    </button>
                    <button class="btn btn-info" onclick="getLatestCheckpoint()">
                        最新检查点
                    </button>
                </div>

                <div class="checkpoint-list" id="checkpointList">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        暂无检查点数据
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label for="restoreCheckpointId">恢复检查点 ID</label>
                    <input type="text" id="restoreCheckpointId" placeholder="留空恢复最新检查点">
                </div>

                <button class="btn btn-warning" onclick="restoreCheckpoint()">
                    恢复检查点
                </button>
            </div>
        </div>

        <!-- 性能监控面板 -->
        <div class="card">
            <h2>📈 性能监控</h2>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="startMonitoring()">
                    开始监控
                </button>
                <button class="btn btn-danger" onclick="stopMonitoring()">
                    停止监控
                </button>
                <button class="btn btn-info" onclick="getPerformanceMetrics()">
                    获取指标
                </button>
            </div>

            <div class="performance-metrics" id="systemMetrics">
                <div class="metric-card">
                    <div class="metric-value" id="cpuUsage">0%</div>
                    <div class="metric-label">CPU 使用率</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="memoryUsage">0%</div>
                    <div class="metric-label">内存使用率</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="activeSessions">0</div>
                    <div class="metric-label">活动会话</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="threadCount">0</div>
                    <div class="metric-label">线程数</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="taskThroughput">0/m</div>
                    <div class="metric-label">任务吞吐量</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="errorRate">0%</div>
                    <div class="metric-label">错误率</div>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">
                    0%
                </div>
            </div>
        </div>

        <!-- 日志查看器 -->
        <div class="card">
            <h2>📝 实时日志</h2>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="startLogStreaming()">
                    开始日志流
                </button>
                <button class="btn btn-danger" onclick="stopLogStreaming()">
                    停止日志流
                </button>
                <button class="btn btn-warning" onclick="clearLogs()">
                    清空日志
                </button>
            </div>

            <div class="log-viewer" id="logViewer">
                <div class="log-entry">
                    <span class="log-time">00:00:00</span>
                    <span class="log-level-info">INFO</span> 等待日志数据...
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px;">处理中...</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8013/api';
        let monitoringInterval = null;
        let logStreamingInterval = null;
        let currentSessionId = null;

        // 显示消息
        function showMessage(message, type = 'info') {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';

            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // 显示加载状态
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // 获取会话ID
        function getSessionId() {
            const sessionId = document.getElementById('sessionId').value;
            if (!sessionId) {
                showMessage('请输入会话ID', 'error');
                return null;
            }
            currentSessionId = sessionId;
            return sessionId;
        }

        // 启动持久化
        async function startPersistence() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/execute/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updatePersistenceStatus(true);
                showMessage('持久化已启动', 'success');
                addLog('INFO', '持久化服务已启动');
            } catch (error) {
                showMessage('启动持久化失败: ' + error.message, 'error');
                addLog('ERROR', '启动持久化失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // 停止持久化
        async function stopPersistence() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/execute/stop/${sessionId}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updatePersistenceStatus(false);
                showMessage('持久化已停止', 'success');
                addLog('INFO', '持久化服务已停止');
            } catch (error) {
                showMessage('停止持久化失败: ' + error.message, 'error');
                addLog('ERROR', '停止持久化失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // 检查持久化状态
        async function checkPersistenceStatus() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/execute/status/${sessionId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const isActive = data.status === 'executing';
                updatePersistenceStatus(isActive);

                // 更新指标
                if (data.task_count) {
                    document.getElementById('tasksPersistedCount').textContent = data.completed_tasks || 0;
                }

                showMessage(`持久化状态: ${isActive ? '活动' : '未激活'}`, 'info');
                addLog('INFO', `检查持久化状态: ${isActive ? '活动' : '未激活'}`);
            } catch (error) {
                showMessage('检查状态失败: ' + error.message, 'error');
                addLog('ERROR', '检查状态失败: ' + error.message);
            }
        }

        // 更新持久化状态显示
        function updatePersistenceStatus(isActive) {
            const statusIndicator = document.getElementById('persistenceStatus');
            const statusText = document.getElementById('persistenceStatusText');

            if (isActive) {
                statusIndicator.className = 'status-indicator status-active';
                statusText.textContent = '活动中';
                document.getElementById('lastPersistTime').textContent = new Date().toLocaleTimeString('zh-CN');
            } else {
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = '未激活';
            }
        }

        // 创建检查点
        async function createCheckpoint() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/execute/checkpoint/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ checkpoint_type: 'manual' })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                showMessage('检查点创建成功', 'success');
                addLog('INFO', `创建检查点: ${data.checkpoint_id}`);
                listCheckpoints();
            } catch (error) {
                showMessage('创建检查点失败: ' + error.message, 'error');
                addLog('ERROR', '创建检查点失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // 列出检查点
        async function listCheckpoints() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                // 模拟检查点数据，实际应该从API获取
                const checkpoints = [
                    {
                        checkpoint_id: '20240130_143022',
                        checkpoint_type: 'auto',
                        created_at: '2024-01-30 14:30:22',
                        progress_data: {
                            total_tasks: 1000,
                            completed_tasks: 750,
                            completion_rate: 75
                        }
                    },
                    {
                        checkpoint_id: '20240130_142522',
                        checkpoint_type: 'manual',
                        created_at: '2024-01-30 14:25:22',
                        progress_data: {
                            total_tasks: 1000,
                            completed_tasks: 500,
                            completion_rate: 50
                        }
                    }
                ];

                displayCheckpoints(checkpoints);
                addLog('INFO', `获取到 ${checkpoints.length} 个检查点`);
            } catch (error) {
                showMessage('获取检查点失败: ' + error.message, 'error');
                addLog('ERROR', '获取检查点失败: ' + error.message);
            }
        }

        // 显示检查点列表
        function displayCheckpoints(checkpoints) {
            const listDiv = document.getElementById('checkpointList');
            if (!checkpoints || checkpoints.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无检查点数据</div>';
                return;
            }

            listDiv.innerHTML = checkpoints.map(cp => `
                <div class="checkpoint-item">
                    <div class="checkpoint-id">ID: ${cp.checkpoint_id}</div>
                    <div class="checkpoint-time">创建时间: ${cp.created_at}</div>
                    <div class="checkpoint-stats">
                        <div class="stat-item">
                            <span class="stat-label">类型:</span>
                            <span class="stat-value">${cp.checkpoint_type}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">完成:</span>
                            <span class="stat-value">${cp.progress_data.completed_tasks}/${cp.progress_data.total_tasks}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">进度:</span>
                            <span class="stat-value">${cp.progress_data.completion_rate}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 获取最新检查点
        async function getLatestCheckpoint() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                // 模拟获取最新检查点
                const latest = {
                    checkpoint_id: '20240130_143022',
                    checkpoint_type: 'auto',
                    created_at: '2024-01-30 14:30:22',
                    progress_data: {
                        total_tasks: 1000,
                        completed_tasks: 750,
                        completion_rate: 75
                    }
                };

                displayCheckpoints([latest]);
                showMessage('已获取最新检查点', 'info');
                addLog('INFO', `最新检查点: ${latest.checkpoint_id}`);
            } catch (error) {
                showMessage('获取最新检查点失败: ' + error.message, 'error');
                addLog('ERROR', '获取最新检查点失败: ' + error.message);
            }
        }

        // 恢复检查点
        async function restoreCheckpoint() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            const checkpointId = document.getElementById('restoreCheckpointId').value;

            showLoading(true);
            try {
                const response = await fetch(`${API_BASE_URL}/execute/checkpoint/restore/${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ checkpoint_id: checkpointId || null })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                showMessage('检查点恢复成功', 'success');
                addLog('INFO', `恢复检查点: ${checkpointId || '最新'}`);
            } catch (error) {
                showMessage('恢复检查点失败: ' + error.message, 'error');
                addLog('ERROR', '恢复检查点失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // 开始性能监控
        function startMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }

            showMessage('性能监控已启动', 'success');
            addLog('INFO', '启动性能监控');

            // 立即获取一次
            getPerformanceMetrics();

            // 定期更新
            monitoringInterval = setInterval(getPerformanceMetrics, 5000);
        }

        // 停止性能监控
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            showMessage('性能监控已停止', 'info');
            addLog('INFO', '停止性能监控');
        }

        // 获取性能指标
        async function getPerformanceMetrics() {
            try {
                // 模拟性能数据，实际应该从API获取
                const metrics = {
                    cpu_percent: Math.random() * 100,
                    memory_percent: Math.random() * 100,
                    active_sessions: Math.floor(Math.random() * 10),
                    thread_count: Math.floor(Math.random() * 50) + 10,
                    throughput: Math.floor(Math.random() * 100),
                    error_rate: Math.random() * 10
                };

                updatePerformanceMetrics(metrics);
            } catch (error) {
                console.error('获取性能指标失败:', error);
            }
        }

        // 更新性能指标显示
        function updatePerformanceMetrics(metrics) {
            document.getElementById('cpuUsage').textContent = `${metrics.cpu_percent.toFixed(1)}%`;
            document.getElementById('memoryUsage').textContent = `${metrics.memory_percent.toFixed(1)}%`;
            document.getElementById('activeSessions').textContent = metrics.active_sessions;
            document.getElementById('threadCount').textContent = metrics.thread_count;
            document.getElementById('taskThroughput').textContent = `${metrics.throughput}/m`;
            document.getElementById('errorRate').textContent = `${metrics.error_rate.toFixed(1)}%`;

            // 更新进度条
            const progress = metrics.memory_percent;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${progress.toFixed(1)}%`;
        }

        // 开始日志流
        function startLogStreaming() {
            if (logStreamingInterval) {
                clearInterval(logStreamingInterval);
            }

            showMessage('日志流已启动', 'success');

            // 执行真实的后端操作并记录详细日志
            const sessionId = getSessionId();
            if (!sessionId) {
                addLog('ERROR', '无法开始日志流：缺少Session ID');
                return;
            }

            // 定期执行实际操作并记录详细错误
            logStreamingInterval = setInterval(async () => {
                try {
                    // 1. 检查持久化状态
                    addLog('INFO', '正在检查持久化状态...');
                    const statusResponse = await fetch(`${API_BASE_URL}/monitor/status/${sessionId}`);
                    if (!statusResponse.ok) {
                        const errorData = await statusResponse.json().catch(() => ({}));
                        addLog('ERROR', `持久化状态检查失败: ${statusResponse.status} - ${errorData.detail || statusResponse.statusText}`);
                    } else {
                        const statusData = await statusResponse.json();
                        addLog('INFO', `持久化状态: 已保存 ${statusData.persisted_count || 0} 个任务`);
                    }

                    // 2. 检查数据库连接池状态
                    const poolResponse = await fetch(`${API_BASE_URL}/pool/stats`);
                    if (!poolResponse.ok) {
                        const errorData = await poolResponse.json().catch(() => ({}));
                        addLog('ERROR', `连接池状态获取失败: ${poolResponse.status} - ${errorData.detail || poolResponse.statusText}`);
                    } else {
                        const poolData = await poolResponse.json();
                        const poolStats = poolData.pool_stats || {};
                        if (poolStats.health === 'critical') {
                            addLog('ERROR', `数据库连接池严重问题: 使用率 ${poolStats.usage_percent}%, 空闲连接: ${poolStats.free}`);
                        } else if (poolStats.health === 'warning') {
                            addLog('WARNING', `数据库连接池警告: 使用率 ${poolStats.usage_percent}%`);
                        } else {
                            addLog('INFO', `连接池正常: ${poolStats.in_use}/${poolStats.max_size} 连接使用中`);
                        }
                    }

                    // 3. 尝试创建检查点
                    const checkpointResponse = await fetch(`${API_BASE_URL}/execute/checkpoint/${sessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ checkpoint_type: 'auto' })
                    });

                    if (!checkpointResponse.ok) {
                        const errorData = await checkpointResponse.json().catch(() => ({}));
                        addLog('ERROR', `检查点创建失败: ${checkpointResponse.status} - ${errorData.detail || checkpointResponse.statusText}`);
                    } else {
                        const checkpointData = await checkpointResponse.json();
                        addLog('INFO', `检查点创建成功: ${checkpointData.checkpoint_id || 'unknown'}`);
                    }

                } catch (networkError) {
                    addLog('ERROR', `网络错误: ${networkError.message}`);
                    addLog('WARNING', '请确保后端服务正在运行 (http://localhost:8013)');
                }
            }, 5000);
        }

        // 停止日志流
        function stopLogStreaming() {
            if (logStreamingInterval) {
                clearInterval(logStreamingInterval);
                logStreamingInterval = null;
            }
            showMessage('日志流已停止', 'info');
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('logViewer').innerHTML = '';
            showMessage('日志已清空', 'info');
        }

        // 添加日志条目
        function addLog(level, message) {
            const logViewer = document.getElementById('logViewer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const time = new Date().toLocaleTimeString('zh-CN');
            const levelClass = `log-level-${level.toLowerCase()}`;

            logEntry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="${levelClass}">${level}</span> ${message}
            `;

            logViewer.appendChild(logEntry);

            // 保持最新日志可见
            logViewer.scrollTop = logViewer.scrollHeight;

            // 限制日志条数
            if (logViewer.children.length > 100) {
                logViewer.removeChild(logViewer.firstChild);
            }
        }

        // ==================== 持久化状态监控功能 ====================

        // 检查持久化状态
        async function checkPersistenceStatus() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                addLog('INFO', '正在检查持久化状态...');

                // 获取任务执行状态（包含持久化信息）
                const response = await fetch(`${API_BASE_URL}/monitor/status/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();

                    // 更新实时状态显示
                    const total = data.progress?.total || 0;
                    const completed = data.progress?.completed || 0;
                    const pending = data.progress?.pending || 0;

                    document.getElementById('savedTasksStatus').textContent = completed;
                    document.getElementById('pendingTasksStatus').textContent = pending;

                    // 模拟持久化时间（实际应从后端获取）
                    const now = new Date();
                    document.getElementById('lastPersistTimeStatus').textContent = now.toLocaleTimeString();

                    // 计算下次保存时间（30秒后）
                    const nextTime = new Date(now.getTime() + 30000);
                    document.getElementById('nextSaveTimeStatus').textContent = nextTime.toLocaleTimeString();

                    addLog('INFO', `持久化状态: 总任务 ${total}，已完成 ${completed}，待处理 ${pending}`);
                } else {
                    addLog('ERROR', `获取状态失败: HTTP ${response.status}`);
                }

            } catch (error) {
                addLog('ERROR', `检查持久化状态失败: ${error.message}`);
            }
        }

        // 验证数据一致性
        async function verifyDataConsistency() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                addLog('INFO', '正在验证数据一致性...');

                // 获取内存和数据库任务数对比
                const response = await fetch(`${API_BASE_URL}/monitor/summary/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();

                    const total = data.task_statistics?.total || 0;
                    const dbTasks = data.task_statistics?.by_status?.completed || 0;

                    document.getElementById('memoryTaskCount').textContent = total;
                    document.getElementById('dbTaskCount').textContent = dbTasks;

                    const difference = Math.abs(total - dbTasks);
                    const syncElement = document.getElementById('syncDifference');
                    const statusElement = document.getElementById('dataConsistencyStatus');

                    if (difference === 0) {
                        syncElement.textContent = '0 (完全同步)';
                        syncElement.style.color = '#4CAF50';
                        statusElement.textContent = '✅ 数据一致';
                        statusElement.style.color = '#4CAF50';
                        addLog('INFO', '✅ 数据一致性验证通过');
                    } else if (difference <= 10) {
                        syncElement.textContent = `${difference} (轻微延迟)`;
                        syncElement.style.color = '#FF9800';
                        statusElement.textContent = '⚠️ 轻微不同步';
                        statusElement.style.color = '#FF9800';
                        addLog('WARNING', `⚠️ 轻微不同步: 差异 ${difference} 个任务`);
                    } else {
                        syncElement.textContent = `${difference} (严重不同步)`;
                        syncElement.style.color = '#F44336';
                        statusElement.textContent = '❌ 数据不一致';
                        statusElement.style.color = '#F44336';
                        addLog('ERROR', `❌ 数据不一致: 差异 ${difference} 个任务`);
                    }

                    document.getElementById('lastConsistencyCheck').textContent = new Date().toLocaleTimeString();
                }
            } catch (error) {
                addLog('ERROR', `验证失败: ${error.message}`);
            }
        }

        // 强制立即持久化
        async function forcePersist() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            try {
                showLoading(true);
                addLog('INFO', '执行强制持久化...');

                // 创建手动检查点（触发持久化）
                const response = await fetch(`${API_BASE_URL}/execute/checkpoint/${sessionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checkpoint_type: 'manual' })
                });

                if (response.ok) {
                    const data = await response.json();
                    addLog('INFO', `✅ 持久化成功: ${data.checkpoint_id}`);
                    showMessage('强制持久化成功', 'success');

                    // 更新状态
                    await checkPersistenceStatus();
                    await verifyDataConsistency();
                } else {
                    const error = await response.json();
                    addLog('ERROR', `持久化失败: ${error.detail}`);
                }
            } catch (error) {
                addLog('ERROR', `请求失败: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // 显示持久化日志
        function showPersistenceLogs() {
            const logsDiv = document.getElementById('persistenceLogs');
            logsDiv.style.display = logsDiv.style.display === 'none' ? 'block' : 'none';

            if (logsDiv.style.display === 'block') {
                updatePersistenceLogs();
            }
        }

        // 更新持久化日志
        function updatePersistenceLogs() {
            const logContent = document.getElementById('persistenceLogContent');
            const logs = [];

            // 收集持久化相关日志
            const logEntries = document.querySelectorAll('#logViewer .log-entry');
            logEntries.forEach(entry => {
                if (entry.textContent.includes('持久化') ||
                    entry.textContent.includes('保存') ||
                    entry.textContent.includes('检查点')) {
                    logs.push(entry.innerHTML);
                }
            });

            logContent.innerHTML = logs.length > 0 ?
                logs.slice(-20).join('<br>') :
                '<span style="color: #999;">暂无持久化日志</span>';
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 尝试从localStorage读取上次的sessionId
            const savedSessionId = localStorage.getItem('lastSessionId');
            if (savedSessionId) {
                document.getElementById('sessionId').value = savedSessionId;
            }

            // 保存sessionId到localStorage
            document.getElementById('sessionId').addEventListener('change', function() {
                localStorage.setItem('lastSessionId', this.value);
            });

            // 初始日志
            addLog('INFO', '持久化管理界面已加载');
            addLog('INFO', '等待用户操作...');

            // 自动检查持久化状态（如果有session ID）
            if (savedSessionId) {
                setTimeout(() => {
                    checkPersistenceStatus();
                    verifyDataConsistency();
                }, 1000);
            }
        });

        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            if (logStreamingInterval) {
                clearInterval(logStreamingInterval);
            }
        });
    </script>
</body>
</html>