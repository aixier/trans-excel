<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>游戏本地化翻译系统 - 调试版</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f8fafc;
      padding: 20px;
    }
    .debug-container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .debug-header {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .debug-content {
      padding: 30px;
    }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .status-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    .status-icon {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .test-section {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      margin: 8px;
      font-size: 14px;
      transition: background 0.2s;
    }
    .btn:hover { background: #1d4ed8; }
    .btn.success { background: #10b981; }
    .btn.danger { background: #ef4444; }
    .btn.warning { background: #f59e0b; }
    .log-container {
      background: #1e293b;
      color: #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.5;
    }
    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.2s;
    }
    .upload-area:hover {
      border-color: #2563eb;
      background: #f8fafc;
    }
    .upload-area.dragover {
      border-color: #2563eb;
      background: #dbeafe;
    }
  </style>
</head>
<body>
  <div class="debug-container">
    <div class="debug-header">
      <h1>🎮 游戏本地化翻译系统</h1>
      <p>前端调试控制台</p>
    </div>

    <div class="debug-content">
      <!-- 状态监控 -->
      <div class="status-grid">
        <div class="status-card">
          <div class="status-icon">🌐</div>
          <h3>后端连接</h3>
          <p id="backend-status">检测中...</p>
        </div>
        <div class="status-card">
          <div class="status-icon">🚀</div>
          <h3>前端状态</h3>
          <p id="frontend-status">正常</p>
        </div>
        <div class="status-card">
          <div class="status-icon">📊</div>
          <h3>API测试</h3>
          <p id="api-test-count">0 次调用</p>
        </div>
      </div>

      <!-- API测试区域 -->
      <div class="test-section">
        <h3>🔗 API连接测试</h3>
        <button class="btn" onclick="testBasicConnection()">基础连接测试</button>
        <button class="btn" onclick="testHealthAPI()">健康检查API</button>
        <button class="btn" onclick="testSystemInfo()">系统信息API</button>
        <button class="btn warning" onclick="testCORS()">CORS测试</button>
      </div>

      <!-- 文件上传测试 -->
      <div class="test-section">
        <h3>📁 文件上传测试</h3>
        <div class="upload-area" id="uploadArea">
          <p>拖拽Excel文件到此处，或点击选择文件</p>
          <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
          <button class="btn" onclick="document.getElementById('fileInput').click()">选择文件</button>
        </div>
        <button class="btn" onclick="testFileAnalyze()" id="analyzeBtn" disabled>分析文件结构</button>
        <button class="btn success" onclick="testFileUpload()" id="uploadBtn" disabled>测试上传</button>
      </div>

      <!-- 前端应用测试 -->
      <div class="test-section">
        <h3>🎨 前端应用测试</h3>
        <button class="btn" onclick="openMainApp()">打开主应用 (http://localhost:3000)</button>
        <button class="btn" onclick="checkDependencies()">检查依赖加载</button>
        <button class="btn warning" onclick="forceReload()">强制重新加载</button>
      </div>

      <!-- 日志输出 -->
      <div class="test-section">
        <h3>📝 调试日志</h3>
        <button class="btn danger" onclick="clearDebugLog()">清除日志</button>
        <div id="debugLog" class="log-container">
系统调试日志将显示在这里...
        </div>
      </div>
    </div>
  </div>

  <script>
    let apiTestCount = 0;
    let selectedFile = null;

    function debugLog(message, type = 'info') {
      const logEl = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      const icons = { info: 'ℹ️', success: '✅', error: '❌', warning: '⚠️' };
      const icon = icons[type] || 'ℹ️';

      const logMessage = `[${timestamp}] ${icon} ${message}`;
      logEl.textContent += logMessage + '\n';
      logEl.scrollTop = logEl.scrollHeight;
      console.log(logMessage);
    }

    async function testBasicConnection() {
      debugLog('开始基础连接测试...');

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const response = await fetch('http://127.0.0.1:8101/', {
          method: 'GET',
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} 次调用`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`基础连接成功: ${JSON.stringify(data)}`, 'success');
          document.getElementById('backend-status').textContent = '✅ 连接正常';
        } else {
          debugLog(`连接失败: ${response.status} ${response.statusText}`, 'error');
          document.getElementById('backend-status').textContent = '❌ 连接失败';
        }
      } catch (error) {
        debugLog(`连接错误: ${error.message}`, 'error');
        document.getElementById('backend-status').textContent = '❌ 无法连接';
      }
    }

    async function testHealthAPI() {
      debugLog('开始健康检查API测试...');

      try {
        const response = await fetch('http://127.0.0.1:8101/api/health/ping');
        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} 次调用`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`健康检查成功: ${JSON.stringify(data)}`, 'success');
        } else {
          debugLog(`健康检查失败: ${response.status}`, 'error');
        }
      } catch (error) {
        debugLog(`健康检查错误: ${error.message}`, 'error');
      }
    }

    async function testSystemInfo() {
      debugLog('开始系统信息API测试...');

      try {
        const response = await fetch('http://127.0.0.1:8101/api/info');
        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} 次调用`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`系统信息: ${JSON.stringify(data, null, 2)}`, 'success');
        } else {
          debugLog(`系统信息获取失败: ${response.status}`, 'error');
        }
      } catch (error) {
        debugLog(`系统信息错误: ${error.message}`, 'error');
      }
    }

    async function testCORS() {
      debugLog('开始CORS测试...');

      try {
        const response = await fetch('http://127.0.0.1:8101/api/health/ping', {
          method: 'OPTIONS',
        });

        debugLog(`CORS预检响应: ${response.status}`, 'success');
        debugLog(`CORS headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
      } catch (error) {
        debugLog(`CORS测试失败: ${error.message}`, 'error');
      }
    }

    function setupFileUpload() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      // 拖拽事件
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      // 文件选择事件
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    function handleFileSelect(file) {
      selectedFile = file;
      debugLog(`文件选择: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`, 'success');

      document.getElementById('analyzeBtn').disabled = false;
      document.getElementById('uploadBtn').disabled = false;

      document.getElementById('uploadArea').innerHTML = `
        <p>✅ 已选择文件: ${file.name}</p>
        <p>大小: ${(file.size / 1024 / 1024).toFixed(2)}MB</p>
        <button class="btn" onclick="document.getElementById('fileInput').click()">重新选择</button>
      `;
    }

    async function testFileAnalyze() {
      if (!selectedFile) {
        debugLog('请先选择文件', 'warning');
        return;
      }

      debugLog('开始文件分析测试...');

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        const response = await fetch('http://127.0.0.1:8101/api/translation/analyze', {
          method: 'POST',
          body: formData
        });

        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} 次调用`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`文件分析成功: ${JSON.stringify(data, null, 2)}`, 'success');
        } else {
          debugLog(`文件分析失败: ${response.status}`, 'error');
        }
      } catch (error) {
        debugLog(`文件分析错误: ${error.message}`, 'error');
      }
    }

    async function testFileUpload() {
      if (!selectedFile) {
        debugLog('请先选择文件', 'warning');
        return;
      }

      debugLog('开始文件上传测试...');

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('target_languages', 'pt,th,ind');
        formData.append('region_code', 'cn-hangzhou');

        const response = await fetch('http://127.0.0.1:8101/api/translation/upload', {
          method: 'POST',
          body: formData
        });

        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} 次调用`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`文件上传成功: ${JSON.stringify(data, null, 2)}`, 'success');
        } else {
          debugLog(`文件上传失败: ${response.status}`, 'error');
        }
      } catch (error) {
        debugLog(`文件上传错误: ${error.message}`, 'error');
      }
    }

    function openMainApp() {
      debugLog('尝试打开主应用...');
      window.open('http://localhost:3000', '_blank');
    }

    function checkDependencies() {
      debugLog('检查依赖加载状态...');
      debugLog(`Node环境变量: ${JSON.stringify({
        NODE_ENV: typeof process !== 'undefined' ? process.env?.NODE_ENV : 'undefined',
        location: window.location.href,
        userAgent: navigator.userAgent.substring(0, 100)
      })}`, 'info');
    }

    function forceReload() {
      debugLog('强制重新加载页面...', 'warning');
      window.location.reload(true);
    }

    function clearDebugLog() {
      document.getElementById('debugLog').textContent = '';
      debugLog('调试日志已清除');
    }

    // 页面初始化
    window.addEventListener('load', () => {
      debugLog('🎉 调试页面加载完成');
      debugLog('📍 当前URL: ' + window.location.href);
      debugLog('🔧 准备进行系统测试...');

      setupFileUpload();

      // 自动测试基础连接
      setTimeout(testBasicConnection, 1000);
    });

    // 错误监听
    window.addEventListener('error', (e) => {
      debugLog(`❌ JavaScript错误: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
      debugLog(`❌ 未处理的Promise错误: ${e.reason}`, 'error');
    });
  </script>
</body>
</html>