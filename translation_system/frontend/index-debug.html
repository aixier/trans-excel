<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸¸æˆæœ¬åœ°åŒ–ç¿»è¯‘ç³»ç»Ÿ - è°ƒè¯•ç‰ˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f8fafc;
      padding: 20px;
    }
    .debug-container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .debug-header {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .debug-content {
      padding: 30px;
    }
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .status-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    .status-icon {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .test-section {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      margin: 8px;
      font-size: 14px;
      transition: background 0.2s;
    }
    .btn:hover { background: #1d4ed8; }
    .btn.success { background: #10b981; }
    .btn.danger { background: #ef4444; }
    .btn.warning { background: #f59e0b; }
    .log-container {
      background: #1e293b;
      color: #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.5;
    }
    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      transition: all 0.2s;
    }
    .upload-area:hover {
      border-color: #2563eb;
      background: #f8fafc;
    }
    .upload-area.dragover {
      border-color: #2563eb;
      background: #dbeafe;
    }
  </style>
</head>
<body>
  <div class="debug-container">
    <div class="debug-header">
      <h1>ğŸ® æ¸¸æˆæœ¬åœ°åŒ–ç¿»è¯‘ç³»ç»Ÿ</h1>
      <p>å‰ç«¯è°ƒè¯•æ§åˆ¶å°</p>
    </div>

    <div class="debug-content">
      <!-- çŠ¶æ€ç›‘æ§ -->
      <div class="status-grid">
        <div class="status-card">
          <div class="status-icon">ğŸŒ</div>
          <h3>åç«¯è¿æ¥</h3>
          <p id="backend-status">æ£€æµ‹ä¸­...</p>
        </div>
        <div class="status-card">
          <div class="status-icon">ğŸš€</div>
          <h3>å‰ç«¯çŠ¶æ€</h3>
          <p id="frontend-status">æ­£å¸¸</p>
        </div>
        <div class="status-card">
          <div class="status-icon">ğŸ“Š</div>
          <h3>APIæµ‹è¯•</h3>
          <p id="api-test-count">0 æ¬¡è°ƒç”¨</p>
        </div>
      </div>

      <!-- APIæµ‹è¯•åŒºåŸŸ -->
      <div class="test-section">
        <h3>ğŸ”— APIè¿æ¥æµ‹è¯•</h3>
        <button class="btn" onclick="testBasicConnection()">åŸºç¡€è¿æ¥æµ‹è¯•</button>
        <button class="btn" onclick="testHealthAPI()">å¥åº·æ£€æŸ¥API</button>
        <button class="btn" onclick="testSystemInfo()">ç³»ç»Ÿä¿¡æ¯API</button>
        <button class="btn warning" onclick="testCORS()">CORSæµ‹è¯•</button>
      </div>

      <!-- æ–‡ä»¶ä¸Šä¼ æµ‹è¯• -->
      <div class="test-section">
        <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
        <div class="upload-area" id="uploadArea">
          <p>æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
          <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
          <button class="btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
        </div>
        <button class="btn" onclick="testFileAnalyze()" id="analyzeBtn" disabled>åˆ†ææ–‡ä»¶ç»“æ„</button>
        <button class="btn success" onclick="testFileUpload()" id="uploadBtn" disabled>æµ‹è¯•ä¸Šä¼ </button>
      </div>

      <!-- å‰ç«¯åº”ç”¨æµ‹è¯• -->
      <div class="test-section">
        <h3>ğŸ¨ å‰ç«¯åº”ç”¨æµ‹è¯•</h3>
        <button class="btn" onclick="openMainApp()">æ‰“å¼€ä¸»åº”ç”¨ (http://localhost:3000)</button>
        <button class="btn" onclick="checkDependencies()">æ£€æŸ¥ä¾èµ–åŠ è½½</button>
        <button class="btn warning" onclick="forceReload()">å¼ºåˆ¶é‡æ–°åŠ è½½</button>
      </div>

      <!-- æ—¥å¿—è¾“å‡º -->
      <div class="test-section">
        <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
        <button class="btn danger" onclick="clearDebugLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="debugLog" class="log-container">
ç³»ç»Ÿè°ƒè¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
        </div>
      </div>
    </div>
  </div>

  <script>
    let apiTestCount = 0;
    let selectedFile = null;

    function debugLog(message, type = 'info') {
      const logEl = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      const icons = { info: 'â„¹ï¸', success: 'âœ…', error: 'âŒ', warning: 'âš ï¸' };
      const icon = icons[type] || 'â„¹ï¸';

      const logMessage = `[${timestamp}] ${icon} ${message}`;
      logEl.textContent += logMessage + '\n';
      logEl.scrollTop = logEl.scrollHeight;
      console.log(logMessage);
    }

    async function testBasicConnection() {
      debugLog('å¼€å§‹åŸºç¡€è¿æ¥æµ‹è¯•...');

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const response = await fetch('http://127.0.0.1:8101/', {
          method: 'GET',
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} æ¬¡è°ƒç”¨`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`åŸºç¡€è¿æ¥æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
          document.getElementById('backend-status').textContent = 'âœ… è¿æ¥æ­£å¸¸';
        } else {
          debugLog(`è¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
          document.getElementById('backend-status').textContent = 'âŒ è¿æ¥å¤±è´¥';
        }
      } catch (error) {
        debugLog(`è¿æ¥é”™è¯¯: ${error.message}`, 'error');
        document.getElementById('backend-status').textContent = 'âŒ æ— æ³•è¿æ¥';
      }
    }

    async function testHealthAPI() {
      debugLog('å¼€å§‹å¥åº·æ£€æŸ¥APIæµ‹è¯•...');

      try {
        const response = await fetch('http://127.0.0.1:8101/api/health/ping');
        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} æ¬¡è°ƒç”¨`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`å¥åº·æ£€æŸ¥æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
        } else {
          debugLog(`å¥åº·æ£€æŸ¥å¤±è´¥: ${response.status}`, 'error');
        }
      } catch (error) {
        debugLog(`å¥åº·æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
      }
    }

    async function testSystemInfo() {
      debugLog('å¼€å§‹ç³»ç»Ÿä¿¡æ¯APIæµ‹è¯•...');

      try {
        const response = await fetch('http://127.0.0.1:8101/api/info');
        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} æ¬¡è°ƒç”¨`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`ç³»ç»Ÿä¿¡æ¯: ${JSON.stringify(data, null, 2)}`, 'success');
        } else {
          debugLog(`ç³»ç»Ÿä¿¡æ¯è·å–å¤±è´¥: ${response.status}`, 'error');
        }
      } catch (error) {
        debugLog(`ç³»ç»Ÿä¿¡æ¯é”™è¯¯: ${error.message}`, 'error');
      }
    }

    async function testCORS() {
      debugLog('å¼€å§‹CORSæµ‹è¯•...');

      try {
        const response = await fetch('http://127.0.0.1:8101/api/health/ping', {
          method: 'OPTIONS',
        });

        debugLog(`CORSé¢„æ£€å“åº”: ${response.status}`, 'success');
        debugLog(`CORS headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');
      } catch (error) {
        debugLog(`CORSæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }

    function setupFileUpload() {
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      // æ‹–æ‹½äº‹ä»¶
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    function handleFileSelect(file) {
      selectedFile = file;
      debugLog(`æ–‡ä»¶é€‰æ‹©: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`, 'success');

      document.getElementById('analyzeBtn').disabled = false;
      document.getElementById('uploadBtn').disabled = false;

      document.getElementById('uploadArea').innerHTML = `
        <p>âœ… å·²é€‰æ‹©æ–‡ä»¶: ${file.name}</p>
        <p>å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)}MB</p>
        <button class="btn" onclick="document.getElementById('fileInput').click()">é‡æ–°é€‰æ‹©</button>
      `;
    }

    async function testFileAnalyze() {
      if (!selectedFile) {
        debugLog('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'warning');
        return;
      }

      debugLog('å¼€å§‹æ–‡ä»¶åˆ†ææµ‹è¯•...');

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        const response = await fetch('http://127.0.0.1:8101/api/translation/analyze', {
          method: 'POST',
          body: formData
        });

        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} æ¬¡è°ƒç”¨`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`æ–‡ä»¶åˆ†ææˆåŠŸ: ${JSON.stringify(data, null, 2)}`, 'success');
        } else {
          debugLog(`æ–‡ä»¶åˆ†æå¤±è´¥: ${response.status}`, 'error');
        }
      } catch (error) {
        debugLog(`æ–‡ä»¶åˆ†æé”™è¯¯: ${error.message}`, 'error');
      }
    }

    async function testFileUpload() {
      if (!selectedFile) {
        debugLog('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'warning');
        return;
      }

      debugLog('å¼€å§‹æ–‡ä»¶ä¸Šä¼ æµ‹è¯•...');

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('target_languages', 'pt,th,ind');
        formData.append('region_code', 'cn-hangzhou');

        const response = await fetch('http://127.0.0.1:8101/api/translation/upload', {
          method: 'POST',
          body: formData
        });

        apiTestCount++;
        document.getElementById('api-test-count').textContent = `${apiTestCount} æ¬¡è°ƒç”¨`;

        if (response.ok) {
          const data = await response.json();
          debugLog(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${JSON.stringify(data, null, 2)}`, 'success');
        } else {
          debugLog(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${response.status}`, 'error');
        }
      } catch (error) {
        debugLog(`æ–‡ä»¶ä¸Šä¼ é”™è¯¯: ${error.message}`, 'error');
      }
    }

    function openMainApp() {
      debugLog('å°è¯•æ‰“å¼€ä¸»åº”ç”¨...');
      window.open('http://localhost:3000', '_blank');
    }

    function checkDependencies() {
      debugLog('æ£€æŸ¥ä¾èµ–åŠ è½½çŠ¶æ€...');
      debugLog(`Nodeç¯å¢ƒå˜é‡: ${JSON.stringify({
        NODE_ENV: typeof process !== 'undefined' ? process.env?.NODE_ENV : 'undefined',
        location: window.location.href,
        userAgent: navigator.userAgent.substring(0, 100)
      })}`, 'info');
    }

    function forceReload() {
      debugLog('å¼ºåˆ¶é‡æ–°åŠ è½½é¡µé¢...', 'warning');
      window.location.reload(true);
    }

    function clearDebugLog() {
      document.getElementById('debugLog').textContent = '';
      debugLog('è°ƒè¯•æ—¥å¿—å·²æ¸…é™¤');
    }

    // é¡µé¢åˆå§‹åŒ–
    window.addEventListener('load', () => {
      debugLog('ğŸ‰ è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ');
      debugLog('ğŸ“ å½“å‰URL: ' + window.location.href);
      debugLog('ğŸ”§ å‡†å¤‡è¿›è¡Œç³»ç»Ÿæµ‹è¯•...');

      setupFileUpload();

      // è‡ªåŠ¨æµ‹è¯•åŸºç¡€è¿æ¥
      setTimeout(testBasicConnection, 1000);
    });

    // é”™è¯¯ç›‘å¬
    window.addEventListener('error', (e) => {
      debugLog(`âŒ JavaScripté”™è¯¯: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
      debugLog(`âŒ æœªå¤„ç†çš„Promiseé”™è¯¯: ${e.reason}`, 'error');
    });
  </script>
</body>
</html>