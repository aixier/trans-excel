<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>游戏本地化翻译系统</title>

  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">

  <!-- 自定义CSS -->
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1e40af;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --info-color: #06b6d4;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-500: #6b7280;
      --gray-900: #111827;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --radius-md: 0.375rem;
      --radius-lg: 0.5rem;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --transition-fast: 150ms ease-in-out;
      --layout-sidebar-width: 240px;
      --layout-header-height: 64px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      color: var(--gray-900);
      background-color: var(--gray-50);
      line-height: 1.5;
    }

    .app-layout {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: var(--layout-sidebar-width);
      background: white;
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      height: var(--layout-header-height);
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--gray-200);
      font-weight: 600;
      font-size: 1.125rem;
      color: var(--primary-color);
    }

    .sidebar-menu {
      flex: 1;
      padding: var(--space-4);
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: var(--space-3) var(--space-4);
      margin-bottom: var(--space-2);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
      color: var(--gray-500);
    }

    .menu-item:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .menu-item.active {
      background: var(--primary-color);
      color: white;
    }

    .menu-item .icon {
      margin-right: var(--space-3);
      font-size: 1.25rem;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      height: var(--layout-header-height);
      background: white;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-6);
    }

    .page-content {
      flex: 1;
      padding: var(--space-6);
      overflow-y: auto;
    }

    .card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      overflow: hidden;
    }

    .card-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .card-body {
      padding: var(--space-6);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      padding: var(--space-2) var(--space-4);
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .upload-area {
      border: 2px dashed var(--gray-200);
      border-radius: var(--radius-lg);
      padding: var(--space-8);
      text-align: center;
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: var(--primary-color);
      background: var(--gray-50);
    }

    .upload-area.dragover {
      border-color: var(--primary-color);
      background: #dbeafe;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin: var(--space-4) 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s ease;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-success { background: #d1fae5; color: #065f46; }
    .status-warning { background: #fef3c7; color: #92400e; }
    .status-error { background: #fee2e2; color: #991b1b; }
    .status-info { background: #dbeafe; color: #1e40af; }

    .hidden { display: none; }
    .loading { opacity: 0.6; pointer-events: none; }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .app-layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        order: 2;
      }

      .main-content {
        order: 1;
      }
    }

    /* 动画 */
    .fade-enter {
      opacity: 0;
      transform: translateY(20px);
    }

    .fade-enter-active {
      transition: all 0.3s ease;
    }

    .fade-enter-to {
      opacity: 1;
      transform: translateY(0);
    }

    /* 调试模态框样式 */
    .debug-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: rgba(0, 0, 0, 0.5);
      cursor: pointer;
    }

    .debug-modal.hidden {
      display: none;
    }

    .debug-modal-content {
      position: relative;
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      max-width: 90%;
      max-height: 90%;
      width: 800px;
      display: flex;
      flex-direction: column;
      z-index: 1001;
      cursor: default;
    }

    .debug-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
    }

    .debug-modal-header h3 {
      margin: 0;
      color: var(--gray-900);
    }

    .debug-close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--gray-500);
      padding: 0.25rem;
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }

    .debug-close-btn:hover {
      background: var(--gray-100);
      color: var(--gray-900);
    }

    .debug-log-content {
      background: #1e293b;
      color: #e2e8f0;
      padding: 1rem;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.75rem;
      line-height: 1.4;
      white-space: pre-wrap;
      overflow-y: auto;
      max-height: 400px;
      margin: 1.5rem;
      border-radius: var(--radius-md);
      flex: 1;
    }

    .debug-modal-footer {
      display: flex;
      justify-content: center;
      gap: 1rem;
      padding: 1.5rem;
      border-top: 1px solid var(--gray-200);
    }

    /* 响应式调试模态框 */
    @media (max-width: 768px) {
      .debug-modal {
        padding: 1rem;
      }

      .debug-modal-content {
        width: 100%;
        max-height: 95%;
      }

      .debug-log-content {
        max-height: 300px;
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="app-layout">
      <!-- 侧边栏 -->
      <div class="sidebar">
        <div class="sidebar-header">
          🎮 翻译系统
        </div>
        <nav class="sidebar-menu">
          <a href="#dashboard" class="menu-item" data-page="dashboard">
            <span class="icon">🏠</span>
            <span>仪表板</span>
          </a>
          <a href="#quick-translation" class="menu-item" data-page="quick-translation">
            <span class="icon">📁</span>
            <span>快速翻译</span>
          </a>
          <a href="#project-management" class="menu-item" data-page="project-management">
            <span class="icon">📊</span>
            <span>项目管理</span>
          </a>
          <a href="#task-center" class="menu-item" data-page="task-center">
            <span class="icon">📋</span>
            <span>任务中心</span>
          </a>
          <a href="#settings" class="menu-item" data-page="settings">
            <span class="icon">⚙️</span>
            <span>系统设置</span>
          </a>
        </nav>
      </div>

      <!-- 主内容区 -->
      <div class="main-content">
        <!-- 顶部导航 -->
        <header class="header">
          <div class="header-left">
            <h2 id="page-title">仪表板</h2>
          </div>
          <div class="header-right">
            <span class="status-badge" id="backend-status">🔗 检测中...</span>
            <button class="btn btn-secondary" onclick="toggleTheme()">🌙</button>
            <button class="btn btn-secondary" onclick="showDebugLog()">🐛</button>
          </div>
        </header>

        <!-- 页面内容 -->
        <main class="page-content">
          <!-- 仪表板页面 -->
          <div id="dashboard-page" class="page">
            <div class="card">
              <div class="card-header">
                <h3>🎮 游戏本地化翻译系统</h3>
                <p>专业的多语言翻译解决方案</p>
              </div>
              <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                  <div class="card" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">📁</div>
                    <h4>快速翻译</h4>
                    <p style="color: var(--gray-500); margin: 0.5rem 0;">上传Excel文件开始翻译</p>
                    <button class="btn btn-primary" onclick="switchToPage('quick-translation')">开始翻译</button>
                  </div>

                  <div class="card" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">📊</div>
                    <h4>项目管理</h4>
                    <p style="color: var(--gray-500); margin: 0.5rem 0;">管理翻译项目和版本</p>
                    <button class="btn btn-secondary" onclick="switchToPage('project-management')">管理项目</button>
                  </div>

                  <div class="card" style="text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">📋</div>
                    <h4>任务中心</h4>
                    <p style="color: var(--gray-500); margin: 0.5rem 0;">查看所有翻译任务</p>
                    <button class="btn btn-secondary" onclick="switchToPage('task-center')">查看任务</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 快速翻译页面 -->
          <div id="quick-translation-page" class="page hidden">
            <div class="card">
              <div class="card-header">
                <h3>📁 快速翻译</h3>
                <p>上传Excel文件，快速完成多语言翻译</p>
              </div>
              <div class="card-body">
                <!-- 步骤指示器 -->
                <div style="display: flex; justify-content: center; margin-bottom: 2rem;">
                  <div class="steps">
                    <div class="step active" id="step-1">①上传文件</div>
                    <div class="step" id="step-2">②配置参数</div>
                    <div class="step" id="step-3">③开始翻译</div>
                    <div class="step" id="step-4">④下载结果</div>
                  </div>
                </div>

                <!-- 上传区域 -->
                <div id="upload-section">
                  <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📄</div>
                    <h3>拖拽Excel文件到此处</h3>
                    <p style="color: var(--gray-500); margin: 1rem 0;">或点击选择文件</p>
                    <button class="btn btn-primary">选择文件</button>
                    <small style="display: block; margin-top: 1rem; color: var(--gray-500);">
                      支持 .xlsx, .xls 格式，最大 10MB
                    </small>
                  </div>
                  <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                </div>

                <!-- 配置区域 -->
                <div id="config-section" class="hidden">
                  <h4>翻译配置</h4>
                  <p style="color: var(--gray-500); margin-bottom: 1.5rem;">
                    📋 请配置翻译参数，系统将自动检测Excel文件结构
                  </p>

                  <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">目标语言</label>
                    <p style="font-size: 0.875rem; color: var(--gray-500); margin-bottom: 1rem;">
                      💡 可选择特定语言，或不选择让系统自动检测所有需要的语言
                    </p>
                    <div id="language-checkboxes" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                      <label><input type="checkbox" value="pt"> 葡萄牙语</label>
                      <label><input type="checkbox" value="th"> 泰语</label>
                      <label><input type="checkbox" value="ind"> 印尼语</label>
                      <label><input type="checkbox" value="tw"> 繁体中文</label>
                      <label><input type="checkbox" value="vn"> 越南语</label>
                      <label><input type="checkbox" value="es"> 西班牙语</label>
                      <label><input type="checkbox" value="tr"> 土耳其语</label>
                      <label><input type="checkbox" value="ja"> 日语</label>
                      <label><input type="checkbox" value="ko"> 韩语</label>
                    </div>
                  </div>

                  <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">地区代码</label>
                    <select id="regionSelect" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-200); border-radius: var(--radius-md);">
                      <option value="cn-hangzhou">中国杭州</option>
                      <option value="na">北美</option>
                      <option value="sa">南美</option>
                      <option value="eu">欧洲</option>
                      <option value="me">中东</option>
                      <option value="as">亚洲</option>
                    </select>
                  </div>

                  <div style="margin: 1.5rem 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">游戏背景</label>
                    <textarea id="gameBackground"
                      placeholder="请描述游戏类型、背景设定等信息，有助于提高翻译质量"
                      style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-200); border-radius: var(--radius-md); min-height: 80px; resize: vertical;"></textarea>
                  </div>

                  <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="backToUpload()">返回上传</button>
                    <button class="btn btn-primary" onclick="startTranslation()">开始翻译</button>
                  </div>
                </div>

                <!-- 进度区域 -->
                <div id="progress-section" class="hidden">
                  <h4>翻译进度</h4>

                  <div style="text-align: center;">
                    <div class="progress-bar">
                      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <p id="progressText">准备开始翻译...</p>
                    <p id="progressDetails" style="color: var(--gray-500); font-size: 0.875rem;"></p>
                  </div>

                  <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="cancelTranslation()" id="cancelBtn">取消翻译</button>
                  </div>
                </div>

                <!-- 结果区域 -->
                <div id="result-section" class="hidden">
                  <div style="text-align: center;">
                    <div style="font-size: 4rem; color: var(--success-color); margin-bottom: 1rem;">✅</div>
                    <h3>翻译完成！</h3>
                    <p style="color: var(--gray-500); margin: 1rem 0;">您的文件已经翻译完成，可以下载了</p>

                    <div style="margin-top: 2rem;">
                      <button class="btn btn-primary" onclick="downloadResult()">📥 下载结果</button>
                      <button class="btn btn-secondary" onclick="startNewTranslation()">🔄 开始新翻译</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 其他页面（占位） -->
          <div id="project-management-page" class="page hidden">
            <div class="card">
              <div class="card-body" style="text-align: center; padding: 4rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">📊</div>
                <h3>项目管理</h3>
                <p style="color: var(--gray-500);">功能开发中，敬请期待</p>
              </div>
            </div>
          </div>

          <div id="task-center-page" class="page hidden">
            <div class="card">
              <div class="card-body" style="text-align: center; padding: 4rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">📋</div>
                <h3>任务中心</h3>
                <p style="color: var(--gray-500);">功能开发中，敬请期待</p>
              </div>
            </div>
          </div>

          <div id="settings-page" class="page hidden">
            <div class="card">
              <div class="card-body" style="text-align: center; padding: 4rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">⚙️</div>
                <h3>系统设置</h3>
                <p style="color: var(--gray-500);">功能开发中，敬请期待</p>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- 调试日志模态框 -->
  <div id="debug-modal" class="debug-modal hidden" onclick="hideDebugLog()">
    <div class="debug-modal-content" onclick="event.stopPropagation()">
      <div class="debug-modal-header">
        <h3>🐛 调试日志</h3>
        <button class="debug-close-btn" onclick="hideDebugLog()">×</button>
      </div>
      <div id="debug-log" class="debug-log-content"></div>
      <div class="debug-modal-footer">
        <button class="btn btn-secondary" onclick="clearLog()">清除日志</button>
        <button class="btn btn-primary" onclick="hideDebugLog()">关闭</button>
      </div>
    </div>
  </div>

  <script>
    console.log('🚀 [系统] 游戏本地化翻译系统启动...')

    // 全局变量
    let currentPage = 'dashboard'
    let selectedFile = null
    let currentTaskId = null
    let progressInterval = null
    const API_BASE = 'http://127.0.0.1:8101'

    // 调试日志
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString()
      const icons = { info: 'ℹ️', success: '✅', error: '❌', warning: '⚠️' }
      const icon = icons[type] || 'ℹ️'

      const logMessage = `[${timestamp}] ${icon} ${message}`
      const debugLogEl = document.getElementById('debug-log')
      if (debugLogEl) {
        debugLogEl.textContent += logMessage + '\n'
        debugLogEl.scrollTop = debugLogEl.scrollHeight
      }
      console.log(logMessage)
    }

    // 页面切换
    function switchToPage(pageName) {
      log(`📄 切换到页面: ${pageName}`)

      // 隐藏所有页面
      document.querySelectorAll('.page').forEach(page => {
        page.classList.add('hidden')
      })

      // 显示目标页面
      const targetPage = document.getElementById(`${pageName}-page`)
      if (targetPage) {
        targetPage.classList.remove('hidden')
      }

      // 更新菜单激活状态
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active')
      })
      document.querySelector(`[data-page="${pageName}"]`).classList.add('active')

      // 更新页面标题
      const titles = {
        'dashboard': '仪表板',
        'quick-translation': '快速翻译',
        'project-management': '项目管理',
        'task-center': '任务中心',
        'settings': '系统设置'
      }
      document.getElementById('page-title').textContent = titles[pageName] || pageName
      currentPage = pageName
    }

    // 后端连接检测
    async function checkBackendStatus() {
      try {
        log('🌐 检测后端服务连接...')
        const response = await fetch(`${API_BASE}/api/health/ping`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        })

        if (response.ok) {
          const data = await response.json()
          log(`✅ 后端连接成功: ${JSON.stringify(data)}`, 'success')
          document.getElementById('backend-status').innerHTML = '🟢 后端正常'
          document.getElementById('backend-status').className = 'status-badge status-success'
          return true
        } else {
          throw new Error(`HTTP ${response.status}`)
        }
      } catch (error) {
        log(`❌ 后端连接失败: ${error.message}`, 'error')
        document.getElementById('backend-status').innerHTML = '🔴 后端离线'
        document.getElementById('backend-status').className = 'status-badge status-error'
        return false
      }
    }

    // 文件上传处理
    function setupFileUpload() {
      const uploadArea = document.getElementById('uploadArea')
      const fileInput = document.getElementById('fileInput')

      // 拖拽事件
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault()
        uploadArea.classList.add('dragover')
      })

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover')
      })

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault()
        uploadArea.classList.remove('dragover')
        const files = e.dataTransfer.files
        if (files.length > 0) {
          handleFileSelect(files[0])
        }
      })

      // 文件选择
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0])
        }
      })
    }

    function handleFileSelect(file) {
      log(`📁 文件选择: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`)

      // 验证文件类型
      if (!file.name.match(/\.(xlsx?|xls)$/i)) {
        log(`❌ 文件格式不支持: ${file.name}`, 'error')
        alert('只支持Excel文件格式 (.xlsx, .xls)')
        return
      }

      // 验证文件大小
      if (file.size > 10 * 1024 * 1024) {
        log(`❌ 文件过大: ${(file.size / 1024 / 1024).toFixed(2)}MB`, 'error')
        alert('文件大小不能超过 10MB')
        return
      }

      selectedFile = file
      log(`✅ 文件验证通过`, 'success')

      // 更新上传区域显示
      uploadArea.innerHTML = `
        <div style="color: var(--success-color);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
          <h3>文件已选择</h3>
          <p><strong>${file.name}</strong></p>
          <p style="color: var(--gray-500);">大小: ${(file.size / 1024 / 1024).toFixed(2)}MB</p>
          <div style="margin-top: 1rem;">
            <button class="btn btn-primary" onclick="proceedToConfig()">▶️ 继续配置</button>
            <button class="btn btn-secondary" onclick="resetUpload()">🔄 重新选择</button>
          </div>
        </div>
      `

      // 跳过分析，直接进入配置
      log('⚡ 跳过文件分析，直接进入配置阶段')
      setTimeout(() => {
        document.getElementById('upload-section').classList.add('hidden')
        document.getElementById('config-section').classList.remove('hidden')
        setStep(2)
      }, 500)
    }

    async function analyzeFile() {
      if (!selectedFile) return

      log('🔍 开始分析文件结构...')

      try {
        const formData = new FormData()
        formData.append('file', selectedFile)

        const response = await fetch(`${API_BASE}/api/translation/analyze`, {
          method: 'POST',
          body: formData
        })

        log(`📊 分析API响应状态: ${response.status} ${response.statusText}`)

        if (response.ok) {
          // 先获取响应文本，再尝试解析JSON
          const responseText = await response.text()
          log(`📄 原始响应内容: ${responseText}`)

          try {
            const data = JSON.parse(responseText)
            log(`✅ 文件分析成功: ${JSON.stringify(data)}`, 'success')

            // 显示配置区域
            document.getElementById('upload-section').classList.add('hidden')
            document.getElementById('config-section').classList.remove('hidden')
            setStep(2)

            // 显示分析结果
            showAnalysisResult(data)
          } catch (jsonError) {
            log(`❌ JSON解析失败: ${jsonError.message}`, 'error')
            log(`🔍 响应内容: ${responseText}`, 'error')
            alert('后端返回的数据格式有误，请检查后端服务')
          }
        } else {
          // 获取错误响应内容
          const errorText = await response.text()
          log(`❌ API请求失败: ${response.status} ${response.statusText}`, 'error')
          log(`🔍 错误响应: ${errorText}`, 'error')

          // 尝试解析错误信息
          try {
            const errorData = JSON.parse(errorText)
            if (errorData.message) {
              alert(`分析失败: ${errorData.message}`)
            } else {
              alert(`分析失败: HTTP ${response.status}`)
            }
          } catch {
            alert(`分析失败: HTTP ${response.status} - ${errorText}`)
          }
        }
      } catch (error) {
        log(`❌ 文件分析网络错误: ${error.message}`, 'error')
        log(`🔍 错误堆栈: ${error.stack}`, 'error')
        alert('网络连接失败，请检查后端服务是否启动')
      }
    }

    function proceedToConfig() {
      log('⚡ 直接进入配置阶段，跳过文件分析')
      document.getElementById('upload-section').classList.add('hidden')
      document.getElementById('config-section').classList.remove('hidden')
      setStep(2)

      // 显示文件信息而不是分析结果
      showFileInfo()
    }

    function showFileInfo() {
      if (!selectedFile) return

      const configSection = document.getElementById('config-section')
      const fileInfoHtml = `
        <div style="background: var(--info-color); background: #e0f2fe; padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border-left: 4px solid var(--info-color);">
          <h5>📁 已选择文件</h5>
          <p><strong>文件名:</strong> ${selectedFile.name}</p>
          <p><strong>文件大小:</strong> ${(selectedFile.size / 1024 / 1024).toFixed(2)}MB</p>
          <p><strong>文件类型:</strong> ${selectedFile.name.split('.').pop().toUpperCase()} 格式</p>
          <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">
            💡 系统将自动检测文件结构并开始翻译
          </p>
        </div>
      `
      configSection.insertAdjacentHTML('afterbegin', fileInfoHtml)
    }

    async function startTranslation() {
      if (!selectedFile) return

      log('🚀 开始翻译任务...')

      // 收集配置
      const checkedLanguages = Array.from(document.querySelectorAll('#language-checkboxes input[type="checkbox"]:checked'))
        .map(cb => cb.value)

      // 允许不选择语言，让后端自动检测
      if (checkedLanguages.length === 0) {
        log('🤖 未选择目标语言，将使用自动检测模式')
      } else {
        log(`🎯 已选择目标语言: ${checkedLanguages.join(', ')}`)
      }

      const config = {
        batch_size: 10,
        max_concurrent: 20,
        region_code: document.getElementById('regionSelect').value,
        auto_detect: 'true'  // 字符串格式，和脚本保持一致
      }

      // 只有选择了语言才添加target_languages参数
      if (checkedLanguages.length > 0) {
        config.target_languages = checkedLanguages.join(',')
      }

      // 只有填写了游戏背景才添加
      const gameBackground = document.getElementById('gameBackground').value.trim()
      if (gameBackground) {
        config.game_background = gameBackground
      }

      log(`⚙️ 翻译配置: ${JSON.stringify(config)}`)

      try {
        const formData = new FormData()
        formData.append('file', selectedFile)
        Object.entries(config).forEach(([key, value]) => {
          if (value) formData.append(key, value)
        })

        const response = await fetch(`${API_BASE}/api/translation/upload`, {
          method: 'POST',
          body: formData
        })

        log(`📊 上传API响应状态: ${response.status} ${response.statusText}`)

        if (response.ok) {
          // 先获取响应文本，再尝试解析JSON
          const responseText = await response.text()
          log(`📄 上传响应内容: ${responseText}`)

          try {
            const data = JSON.parse(responseText)
            currentTaskId = data.task_id
            log(`✅ 翻译任务创建成功: ${currentTaskId}`, 'success')

            // 切换到进度页面
            document.getElementById('config-section').classList.add('hidden')
            document.getElementById('progress-section').classList.remove('hidden')
            setStep(3)

            // 开始监控进度
            startProgressMonitoring()
          } catch (jsonError) {
            log(`❌ 上传响应JSON解析失败: ${jsonError.message}`, 'error')
            log(`🔍 响应内容: ${responseText}`, 'error')
            alert('后端返回的数据格式有误')
          }
        } else {
          // 获取错误响应内容
          const errorText = await response.text()
          log(`❌ 上传API请求失败: ${response.status}`, 'error')
          log(`🔍 错误响应: ${errorText}`, 'error')

          try {
            const errorData = JSON.parse(errorText)
            alert(`上传失败: ${errorData.message || errorData.error || '未知错误'}`)
          } catch {
            alert(`上传失败: HTTP ${response.status}`)
          }
        }
      } catch (error) {
        log(`❌ 翻译启动失败: ${error.message}`, 'error')
        alert('翻译启动失败，请检查后端服务')
      }
    }

    function startProgressMonitoring() {
      if (!currentTaskId) return

      log('📊 开始监控翻译进度...')

      progressInterval = setInterval(async () => {
        try {
          const response = await fetch(`${API_BASE}/api/translation/tasks/${currentTaskId}/progress`)

          if (response.ok) {
            const data = await response.json()
            updateProgress(data)

            if (['completed', 'failed', 'cancelled'].includes(data.status)) {
              clearInterval(progressInterval)

              if (data.status === 'completed') {
                showResult()
              } else {
                log(`❌ 翻译任务${data.status}: ${data.error_message || ''}`, 'error')
                alert(`翻译任务${data.status}`)
                resetTranslation()
              }
            }
          } else {
            log(`⚠️ 进度查询失败: HTTP ${response.status}`, 'warning')
          }
        } catch (error) {
          log(`❌ 进度监控错误: ${error.message}`, 'error')
        }
      }, 2000)
    }

    function updateProgress(data) {
      const percentage = data.progress.completion_percentage || 0
      document.getElementById('progressFill').style.width = `${percentage}%`
      document.getElementById('progressText').textContent = `翻译进度: ${percentage.toFixed(1)}%`

      const details = `已完成: ${data.progress.translated_rows}/${data.progress.total_rows} | 当前Sheet: ${data.current_sheet || '未知'}`
      document.getElementById('progressDetails').textContent = details

      log(`📊 进度更新: ${percentage.toFixed(1)}% - ${details}`)
    }

    function showResult() {
      log('🎉 翻译任务完成！', 'success')
      document.getElementById('progress-section').classList.add('hidden')
      document.getElementById('result-section').classList.remove('hidden')
      setStep(4)
    }

    async function downloadResult() {
      if (!currentTaskId) return

      log('📥 开始下载翻译结果...')

      try {
        const link = document.createElement('a')
        link.href = `${API_BASE}/api/translation/tasks/${currentTaskId}/download`
        link.download = 'translated_result.xlsx'
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)

        log('✅ 下载链接已触发', 'success')
      } catch (error) {
        log(`❌ 下载失败: ${error.message}`, 'error')
        alert('下载失败')
      }
    }

    function cancelTranslation() {
      if (progressInterval) {
        clearInterval(progressInterval)
      }

      if (currentTaskId) {
        fetch(`${API_BASE}/api/translation/tasks/${currentTaskId}`, { method: 'DELETE' })
          .then(() => log('🚫 翻译任务已取消', 'warning'))
          .catch(error => log(`❌ 取消任务失败: ${error.message}`, 'error'))
      }

      resetTranslation()
    }

    function resetTranslation() {
      document.getElementById('progress-section').classList.add('hidden')
      document.getElementById('result-section').classList.add('hidden')
      document.getElementById('upload-section').classList.remove('hidden')
      resetUpload()
      setStep(1)
    }

    function startNewTranslation() {
      resetTranslation()
    }

    function resetUpload() {
      selectedFile = null
      currentTaskId = null

      document.getElementById('uploadArea').innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 1rem;">📄</div>
        <h3>拖拽Excel文件到此处</h3>
        <p style="color: var(--gray-500); margin: 1rem 0;">或点击选择文件</p>
        <button class="btn btn-primary">选择文件</button>
        <small style="display: block; margin-top: 1rem; color: var(--gray-500);">
          支持 .xlsx, .xls 格式，最大 10MB
        </small>
      `

      document.getElementById('fileInput').value = ''
      log('🔄 上传区域已重置')
    }

    function backToUpload() {
      document.getElementById('config-section').classList.add('hidden')
      document.getElementById('upload-section').classList.remove('hidden')
      setStep(1)
    }

    function setStep(stepNumber) {
      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed')
        if (index + 1 < stepNumber) {
          step.classList.add('completed')
        } else if (index + 1 === stepNumber) {
          step.classList.add('active')
        }
      })
    }

    function showDebugLog() {
      log('🐛 打开调试日志窗口')
      const modal = document.getElementById('debug-modal')
      modal.classList.remove('hidden')

      // 聚焦到模态框以支持键盘事件
      modal.focus()
    }

    function hideDebugLog() {
      log('❌ 关闭调试日志窗口')
      const modal = document.getElementById('debug-modal')
      modal.classList.add('hidden')
    }

    function clearLog() {
      document.getElementById('debug-log').textContent = ''
      log('🧹 日志已清除')
    }

    function toggleTheme() {
      document.body.classList.toggle('dark')
      log('🌙 主题已切换')
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      log('🎉 系统初始化完成')
      log('📍 当前页面: ' + window.location.href)

      // 设置菜单点击事件
      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault()
          const pageName = item.getAttribute('data-page')
          switchToPage(pageName)
        })
      })

      // 初始化文件上传
      setupFileUpload()

      // 检测后端状态
      checkBackendStatus()

      // 设置默认页面
      switchToPage('dashboard')

      log('🚀 系统就绪，可以开始使用！', 'success')
    })

    // 键盘事件监听
    document.addEventListener('keydown', (e) => {
      // ESC键关闭调试窗口
      if (e.key === 'Escape') {
        const modal = document.getElementById('debug-modal')
        if (!modal.classList.contains('hidden')) {
          hideDebugLog()
        }
      }
    })

    // 错误监听
    window.addEventListener('error', (e) => {
      log(`💥 JavaScript错误: ${e.message} at ${e.filename}:${e.lineno}`, 'error')
    })

    window.addEventListener('unhandledrejection', (e) => {
      log(`💥 未处理的Promise错误: ${e.reason}`, 'error')
    })
  </script>

  <style>
    .steps {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .step {
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      background: var(--gray-100);
      color: var(--gray-500);
      font-weight: 500;
      transition: all var(--transition-fast);
    }

    .step.active {
      background: var(--primary-color);
      color: white;
    }

    .step.completed {
      background: var(--success-color);
      color: white;
    }

    .step:not(:last-child)::after {
      content: '→';
      margin-left: 1rem;
      color: var(--gray-400);
    }
  </style>
</body>
</html>