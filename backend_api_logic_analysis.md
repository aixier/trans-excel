# Translation System Backend æ¥å£é€»è¾‘å’Œæ—¶åºå…³ç³»åˆ†æ

## ğŸŒ APIæ¥å£æ¶æ„

### 1. è·¯ç”±æ¨¡å—ç»“æ„
```
api_gateway/
â”œâ”€â”€ main.py                    # FastAPIä¸»åº”ç”¨
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ health.py             # å¥åº·æ£€æŸ¥æ¥å£
â”‚   â”œâ”€â”€ translation.py        # ç¿»è¯‘æœåŠ¡æ¥å£
â”‚   â””â”€â”€ project.py           # é¡¹ç›®ç®¡ç†æ¥å£
â””â”€â”€ models/
    â””â”€â”€ task.py              # æ•°æ®æ¨¡å‹å®šä¹‰
```

### 2. æ ¸å¿ƒAPIæ¥å£æ¸…å•

#### A. å¥åº·æ£€æŸ¥æ¨¡å— (`/api/health`)
```
GET /api/health/ping          # åŸºç¡€pingæ£€æŸ¥
GET /api/health/status        # è¯¦ç»†å¥åº·çŠ¶æ€ï¼ˆå«æ•°æ®åº“ï¼‰
GET /api/health/ready         # å°±ç»ªæ¢é’ˆï¼ˆK8sç”¨ï¼‰
GET /api/health/live          # å­˜æ´»æ¢é’ˆï¼ˆK8sç”¨ï¼‰
```

#### B. ç¿»è¯‘æœåŠ¡æ¨¡å— (`/api/translation`)
```
POST /api/translation/upload            # æ–‡ä»¶ä¸Šä¼ å’Œä»»åŠ¡åˆ›å»º
GET  /api/translation/tasks/{id}/status # ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
GET  /api/translation/tasks/{id}/progress # ä»»åŠ¡è¿›åº¦æŸ¥è¯¢
GET  /api/translation/tasks             # ä»»åŠ¡åˆ—è¡¨
DELETE /api/translation/tasks/{id}      # å–æ¶ˆä»»åŠ¡
POST /api/translation/analyze           # Excelç»“æ„åˆ†æ
GET  /api/translation/tasks/{id}/download # ä¸‹è½½ç»“æœ
```

#### C. é¡¹ç›®ç®¡ç†æ¨¡å— (`/api/project`)
```
POST /api/project/create                # åˆ›å»ºé¡¹ç›®
GET  /api/project/{id}/summary          # é¡¹ç›®æ¦‚è¦
POST /api/project/{id}/versions         # åˆ›å»ºç‰ˆæœ¬
GET  /api/project/list                  # é¡¹ç›®åˆ—è¡¨
DELETE /api/project/{id}                # åˆ é™¤é¡¹ç›®
```

## â±ï¸ ç¿»è¯‘ä»»åŠ¡æ—¶åºå…³ç³»åˆ†æ

### ç¬¬1é˜¶æ®µï¼šä»»åŠ¡åˆ›å»º (uploadæ¥å£)

#### **æ—¶åº1: æ–‡ä»¶ä¸Šä¼ ** (0-5ç§’)
```python
1. æ¥æ”¶æ–‡ä»¶ â†’ ä¿å­˜åˆ°tempç›®å½•
2. åˆ†æExcelç»“æ„ â†’ è®¡ç®—total_rows (36385ä¸ªä»»åŠ¡)
3. åˆ›å»ºTranslationTaskè®°å½• â†’ å­˜å…¥æ•°æ®åº“
4. å¯åŠ¨åå°ç¿»è¯‘ä»»åŠ¡ â†’ background_tasks.add_task()
5. è¿”å›task_id â†’ å®¢æˆ·ç«¯å¼€å§‹è½®è¯¢
```

#### **å…³é”®æ•°æ®æµ**:
```
Excelæ–‡ä»¶ â†’ HeaderAnalyzer â†’ total_rowsè®¡ç®— â†’ æ•°æ®åº“å­˜å‚¨
```

### ç¬¬2é˜¶æ®µï¼šç¿»è¯‘å¤„ç† (translation_engine)

#### **æ—¶åº2: ç¿»è¯‘å¼•æ“å¯åŠ¨** (5-10ç§’)
```python
1. åŠ è½½Excelæ–‡ä»¶ â†’ è¯†åˆ«éœ€è¦å¤„ç†çš„Sheet
2. åˆå§‹åŒ–ç¿»è¯‘ç»„ä»¶ â†’ PlaceholderProtector, LocalizationEngineç­‰
3. è®¾ç½®å…¨å±€è®¡æ•°å™¨ â†’ self.total_translated_rows = 0
```

#### **æ—¶åº3: Sheetçº§å¤„ç†** (æŒ‰Sheeté¡ºåº)
```python
for each sheet:
    1. åˆ†æSheetç»“æ„ â†’ HeaderAnalyzer.analyze_sheet()
    2. åˆå§‹ä»»åŠ¡æ£€æµ‹ â†’ TranslationDetector.detect_translation_tasks()
    3. è¿›å…¥è¿­ä»£ç¿»è¯‘å¾ªç¯ (æœ€å¤š5è½®)
```

#### **æ—¶åº4: è¿­ä»£ç¿»è¯‘å¾ªç¯** (æ¯è½®10-60åˆ†é’Ÿ)
```python
while iteration < 5:
    1. é‡æ–°æ£€æµ‹å‰©ä½™ä»»åŠ¡ â†’ detect_translation_tasks() ğŸš¨é—®é¢˜ç‚¹
    2. åŠ¨æ€è°ƒæ•´æ‰¹æ¬¡å‚æ•° â†’ batch_size, timeout
    3. åˆ›å»ºå¹¶å‘æ‰¹æ¬¡ â†’ 20ä¸ªæ‰¹æ¬¡åŒæ—¶è¿è¡Œ
    4. LLM APIè°ƒç”¨ â†’ æ‰¹é‡ç¿»è¯‘
    5. åº”ç”¨ç¿»è¯‘ç»“æœ â†’ æ›´æ–°DataFrame
    6. ç´¯åŠ è¿›åº¦è®¡æ•° â†’ total_translated_rows += è¡Œæ•° ğŸš¨é—®é¢˜ç‚¹
    7. æ›´æ–°æ•°æ®åº“è¿›åº¦ â†’ progress_queue
```

### ç¬¬3é˜¶æ®µï¼šè¿›åº¦ç›‘æ§ (progressæ¥å£)

#### **æ—¶åº5: è¿›åº¦æŸ¥è¯¢å¾ªç¯** (å®¢æˆ·ç«¯5ç§’è½®è¯¢)
```python
1. å®¢æˆ·ç«¯è¯·æ±‚ â†’ GET /api/translation/tasks/{id}/progress
2. æŸ¥è¯¢æ•°æ®åº“ â†’ TranslationTaskè¡¨
3. è®¡ç®—ç™¾åˆ†æ¯” â†’ translated_rows / total_rows
4. è¿”å›è¿›åº¦æ•°æ® â†’ JSONå“åº”
```

#### **æ—¶åº6: è¿›åº¦é˜Ÿåˆ—æ›´æ–°** (åå°5ç§’æ‰¹é‡)
```python
1. ç¿»è¯‘å¼•æ“ â†’ è¿›åº¦æ•°æ®å…¥é˜Ÿ
2. é˜Ÿåˆ—ç®¡ç†å™¨ â†’ æ¯5ç§’æ‰¹é‡æ›´æ–°æ•°æ®åº“
3. ç¼“å­˜æœºåˆ¶ â†’ å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›
```

### ç¬¬4é˜¶æ®µï¼šä»»åŠ¡å®Œæˆ (downloadæ¥å£)

#### **æ—¶åº7: ç»“æœä¿å­˜** (ç¿»è¯‘å®Œæˆæ—¶)
```python
1. æ‰€æœ‰Sheetå¤„ç†å®Œæˆ â†’ åˆå¹¶ç»“æœ
2. ä¿å­˜Excelæ–‡ä»¶ â†’ tempç›®å½•
3. æ›´æ–°ä»»åŠ¡çŠ¶æ€ â†’ status='completed'
```

#### **æ—¶åº8: ä¸‹è½½æœåŠ¡** (å®¢æˆ·ç«¯è¯·æ±‚æ—¶)
```python
1. éªŒè¯ä»»åŠ¡çŠ¶æ€ â†’ å¿…é¡»ä¸ºcompleted
2. æŸ¥æ‰¾ç»“æœæ–‡ä»¶ â†’ tempç›®å½•
3. è¿”å›æ–‡ä»¶æµ â†’ äºŒè¿›åˆ¶å“åº”
```

## ğŸš¨ **å…³é”®é—®é¢˜ç‚¹åˆ†æ**

### **é—®é¢˜ç‚¹1: è¿›åº¦è®¡ç®—å•ä½æ··ä¹±**

#### **ä¸Šä¼ æ—¶** (æ­£ç¡®):
```python
total_rows = æ‰€æœ‰Sheetçš„(è¡Œæ•° Ã— è¯­è¨€åˆ—æ•°) = 36385ä¸ªä»»åŠ¡
```

#### **ç¿»è¯‘æ—¶** (é”™è¯¯):
```python
translated_rows += unique_rows_in_batch  # ç´¯åŠ è¡Œæ•°è€Œéä»»åŠ¡æ•°ï¼
```

#### **æ—¶åºå†²çª**:
- **T0**: total_rows=36385ä»»åŠ¡ (ä¸Šä¼ æ—¶)
- **T1**: translated_rows+=è¡Œæ•° (ç¿»è¯‘æ—¶)
- **T2**: ç™¾åˆ†æ¯”=(è¡Œæ•°ç´¯åŠ )/(ä»»åŠ¡æ•°) > 100% âŒ

### **é—®é¢˜ç‚¹2: é‡å¤è¿­ä»£æ£€æµ‹é€»è¾‘**

#### **æ¯è½®è¿­ä»£æ—¶åº**:
```
T1: detect_translation_tasks() â†’ å‘ç°282ä¸ªä»»åŠ¡
T2: å¤„ç†æ‰¹æ¬¡ â†’ å®Œæˆç¿»è¯‘ â†’ å¡«å…¥DataFrame
T3: detect_translation_tasks() â†’ å†æ¬¡æ£€æµ‹ â†’ å‘ç°188ä¸ªä»»åŠ¡
T4: åˆå¼€å§‹å¤„ç†...
```

#### **é‡å¤æ£€æµ‹åŸå› **:
1. **çŸ­å†…å®¹åˆ¤æ–­**: `len(text) < 2` â†’ 'modify'
2. **è´¨é‡è¿‡ä¸¥**: å·²ç¿»è¯‘å†…å®¹è¢«æ ‡è®°éœ€è¦é‡ç¿»
3. **çŠ¶æ€ä¸¢å¤±**: æ²¡æœ‰è®°å½•"å·²å¤„ç†"æ ‡è®°

### **é—®é¢˜ç‚¹3: æ•°æ®åº“æ›´æ–°æ—¶åº**

#### **æ›´æ–°æ—¶åº**:
```
ç¿»è¯‘å¼•æ“ â†’ è¿›åº¦é˜Ÿåˆ— â†’ æ•°æ®åº“æ›´æ–° â†’ APIæŸ¥è¯¢
    â†“         â†“         â†“         â†“
  å®æ—¶      5ç§’æ‰¹é‡    å†™å…¥DB    ç«‹å³è¯»å–
```

#### **æ—¶åºé—®é¢˜**:
- **å†™å…¥å»¶è¿Ÿ**: 5ç§’æ‰¹é‡æ›´æ–°ï¼Œå¯èƒ½ä¸¢å¤±å®æ—¶çŠ¶æ€
- **è¯»å†™å†²çª**: é«˜å¹¶å‘ä¸‹å¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´

## ğŸ¯ **æ ¹æœ¬é€»è¾‘ç¼ºé™·æ€»ç»“**

### **é€»è¾‘ç¼ºé™·1: æ¦‚å¿µæ··ä¹±**
- **ä¸Šä¼ é˜¶æ®µ**: æŒ‰ç¿»è¯‘ä»»åŠ¡è®¡ç®—æ€»æ•°
- **å¤„ç†é˜¶æ®µ**: æŒ‰è¡Œæ•°ç´¯åŠ è¿›åº¦
- **ç»“æœ**: åˆ†æ¯åˆ†å­å•ä½ä¸ä¸€è‡´ â†’ è¶…è¿‡100%

### **é€»è¾‘ç¼ºé™·2: è¿­ä»£è®¾è®¡é”™è¯¯**
- **é¢„æœŸ**: å¤„ç†å¤±è´¥ä»»åŠ¡çš„å¢é‡è¿­ä»£
- **å®é™…**: é‡å¤æ£€æµ‹æ‰€æœ‰å†…å®¹çš„æš´åŠ›è¿­ä»£
- **ç»“æœ**: èµ„æºæµªè´¹ + é‡å¤è®¡æ•°

### **é€»è¾‘ç¼ºé™·3: çŠ¶æ€ç®¡ç†ç¼ºå¤±**
- **ç¼ºå°‘**: å·²å¤„ç†ä»»åŠ¡çš„çŠ¶æ€è®°å½•
- **å¯¼è‡´**: æ¯è½®è¿­ä»£é‡æ–°è¯„ä¼°æ‰€æœ‰å•å…ƒæ ¼
- **ç»“æœ**: æ— æ³•æ”¶æ•›ï¼Œåå¤å¤„ç†

### **é€»è¾‘ç¼ºé™·4: æ•°æ®åŒæ­¥é—®é¢˜**
- **å¼‚æ­¥æ›´æ–°**: ç¿»è¯‘è¿›åº¦ â†’ é˜Ÿåˆ— â†’ æ•°æ®åº“ â†’ API
- **å¯èƒ½ä¸¢å¤±**: æœ€ç»ˆçŠ¶æ€æ›´æ–°å¤±è´¥
- **è¡¨ç°**: ä»»åŠ¡å®é™…å®Œæˆä½†çŠ¶æ€å¡ä½

## ğŸ“ˆ **æ¥å£è°ƒç”¨æµç¨‹å›¾**

```
å®¢æˆ·ç«¯ä¸Šä¼  â†’ POST /upload â†’ åˆ›å»ºä»»åŠ¡ â†’ è¿”å›task_id
     â†“
å®¢æˆ·ç«¯è½®è¯¢ â†’ GET /progress â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å›ç™¾åˆ†æ¯”
     â†“                           â†‘
   [é‡å¤è½®è¯¢]              â† ç¿»è¯‘å¼•æ“æ›´æ–° â†
     â†“
çŠ¶æ€=completed â†’ GET /download â†’ è¿”å›æ–‡ä»¶
```

**å…³é”®å‘ç°**: å½“å‰ç³»ç»Ÿæ²¡æœ‰ä½¿ç”¨excel_processorçš„llm_batchï¼Œæ˜¯å®Œå…¨ç‹¬ç«‹çš„å®ç°ï¼Œä½†å­˜åœ¨æ˜æ˜¾çš„é€»è¾‘è®¾è®¡é—®é¢˜ï¼